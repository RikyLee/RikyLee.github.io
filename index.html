<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="享受生活，享受自己">
<meta property="og:type" content="website">
<meta property="og:title" content="工作杂记">
<meta property="og:url" content="https://aiguanglee.github.io/index.html">
<meta property="og:site_name" content="工作杂记">
<meta property="og:description" content="享受生活，享受自己">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="工作杂记">
<meta name="twitter:description" content="享受生活，享受自己">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"搜索关键字","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://aiguanglee.github.io/"/>





  <title>工作杂记</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">工作杂记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2018/03/21/SpringBoot-MongoDB多数据源配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/21/SpringBoot-MongoDB多数据源配置/" itemprop="url">Spring Boot MongoDB多数据源配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-21T17:07:00+08:00">
                2018-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/03/21/SpringBoot-MongoDB多数据源配置/" class="leancloud_visitors" data-flag-title="Spring Boot MongoDB多数据源配置">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="多数据源配置"><a href="#多数据源配置" class="headerlink" title="多数据源配置"></a>多数据源配置</h2><ul>
<li><p>创建一个基础的Spring Boot项目</p>
</li>
<li><p>在pom.xml中引入两个依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中spring-boot-starter-data-mongodb，是Spring Boot封装的对MongoDB自动化配置的实现，spring-boot-configuration-processor是因为在使用ConfigurationProperties注解的使用自定义配置。</p>
</li>
<li><p>在src/main/resources/application.properties中添加以下配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#Authentication database1</span><br><span class="line">spring.data.mongodb.userdb1.authentication-database=userdb1</span><br><span class="line"># Database name.</span><br><span class="line">spring.data.mongodb.userdb1.database=userdb1</span><br><span class="line"># Mongo server host.</span><br><span class="line">spring.data.mongodb.userdb1.host=mongo.rikylee.com</span><br><span class="line"># Mongo server port.</span><br><span class="line">spring.data.mongodb.userdb1.port=27020</span><br><span class="line"># Login password of the mongo server.</span><br><span class="line">spring.data.mongodb.userdb1.password=userdb1</span><br><span class="line"># Login user of the mongo server.</span><br><span class="line">spring.data.mongodb.userdb1.username=userdb1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Authentication database2</span><br><span class="line">spring.data.mongodb.userdb2.authentication-database=userdb2</span><br><span class="line"># Database name.</span><br><span class="line">spring.data.mongodb.userdb2.database=userdb2</span><br><span class="line"># Mongo server host.</span><br><span class="line">spring.data.mongodb.userdb2.host=mongo.rikylee.com</span><br><span class="line"># Mongo server port.</span><br><span class="line">spring.data.mongodb.userdb2.port=27020</span><br><span class="line"># Login password of the mongo server.</span><br><span class="line">spring.data.mongodb.userdb2.password=userdb2</span><br><span class="line"># Login user of the mongo server.</span><br><span class="line">spring.data.mongodb.userdb2.username=userdb2</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建抽象类AbstractMongoConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.mongo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mongodb.MongoClient;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.MongoClientOptions;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.MongoCredential;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.ServerAddress;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.MongoDbFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.SimpleMongoDbFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">* <span class="doctag">@create</span> 2018-03-21 13:52:28</span></span><br><span class="line"><span class="comment">* <span class="doctag">@desciption</span>:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMongoConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//定义相关连接数据库参数</span></span><br><span class="line">    <span class="keyword">private</span> String host, database, username, password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDatabase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> database;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDatabase</span><span class="params">(String database)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.database = database;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建MongoDbFactory，不同数据源继承该方法创建对应的MongoDbFactory。</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MongoDbFactory <span class="title">mongoDbFactory</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ServerAddress serverAddress = <span class="keyword">new</span> ServerAddress(host, port);</span><br><span class="line">        MongoCredential mongoCredential = MongoCredential.createCredential(username, database, password.toCharArray());</span><br><span class="line">        MongoClientOptions options = MongoClientOptions.builder()</span><br><span class="line">                .connectionsPerHost(<span class="number">100</span>)</span><br><span class="line">                .socketTimeout(<span class="number">30000</span>)</span><br><span class="line">                .connectTimeout(<span class="number">3000</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleMongoDbFactory(<span class="keyword">new</span> MongoClient(serverAddress, mongoCredential, options), database);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 抽象方法，用于返回MongoTemplate</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> MongoTemplate <span class="title">getMongoTemplate</span><span class="params">(MongoMappingContext context)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建多个数据源对象</p>
<p>创建UserDb1数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.mongo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.convert.DefaultDbRefResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.convert.MappingMongoConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">* <span class="doctag">@create</span> 2018-03-21 14:04:17</span></span><br><span class="line"><span class="comment">* <span class="doctag">@desciption</span>:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.data.mongodb.userdb1"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDb1Config</span> <span class="keyword">extends</span> <span class="title">AbstractMongoConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//设置为默认数据源，如果定义mongoTemplate的时候未指定数据源，将默认为此数据源</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@Bean</span>(name = <span class="string">"userDb1MongoTemplate"</span>) <span class="function">MongoTemplate <span class="title">getMongoTemplate</span><span class="params">(MongoMappingContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//去除保存实体时，spring data mongodb 自动添加的_class字段</span></span><br><span class="line">        MappingMongoConverter converter = <span class="keyword">new</span> MappingMongoConverter(<span class="keyword">new</span> DefaultDbRefResolver(mongoDbFactory()), context);</span><br><span class="line">        converter.setTypeMapper(<span class="keyword">new</span> DefaultMongoTypeMapper(<span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line">        MongoTemplate mongoTemplate = <span class="keyword">new</span> MongoTemplate(mongoDbFactory(), converter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mongoTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建UserDb2数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.mongo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.convert.DefaultDbRefResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.convert.MappingMongoConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">* <span class="doctag">@create</span> 2018-03-21 14:05:02</span></span><br><span class="line"><span class="comment">* <span class="doctag">@desciption</span>:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.data.mongodb.userdb2"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDb2Config</span> <span class="keyword">extends</span> <span class="title">AbstractMongoConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@Bean</span>(name = <span class="string">"userDb2MongoTemplate"</span>) <span class="function">MongoTemplate <span class="title">getMongoTemplate</span><span class="params">(MongoMappingContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">         <span class="comment">//去除保存实体时，spring data mongodb 自动添加的_class字段</span></span><br><span class="line">        MappingMongoConverter converter = <span class="keyword">new</span> MappingMongoConverter(<span class="keyword">new</span> DefaultDbRefResolver(mongoDbFactory()), context);</span><br><span class="line">        converter.setTypeMapper(<span class="keyword">new</span> DefaultMongoTypeMapper(<span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line">        MongoTemplate mongoTemplate = <span class="keyword">new</span> MongoTemplate(mongoDbFactory(), converter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mongoTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在UserDb1和UserDb2中各创建一个collention名为user，建立相应的实体映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.mongo.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">* <span class="doctag">@create</span> 2018-03-21 14:12:53</span></span><br><span class="line"><span class="comment">* <span class="doctag">@desciption</span>:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Document</span>(collection = <span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String passwd;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPasswd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> passwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPasswd</span><span class="params">(String passwd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.passwd = passwd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用MongoTemplate连接mongo数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.mongo.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.riky.mongo.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">* <span class="doctag">@create</span> 2018-03-21 14:29:00</span></span><br><span class="line"><span class="comment">* <span class="doctag">@desciption</span>:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(value = <span class="string">"userDb1MongoTemplate"</span>)</span><br><span class="line">    <span class="keyword">private</span> MongoTemplate userDb1MongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(value = <span class="string">"userDb2MongoTemplate"</span>)</span><br><span class="line">    <span class="keyword">private</span> MongoTemplate userDb2MongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById_UserDb1</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        User user = userDb1MongoTemplate.findOne(<span class="keyword">new</span> Query(Criteria.where(<span class="string">"id"</span>).is(id)), User.class);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById_UserDb2</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        User user = userDb2MongoTemplate.findOne(<span class="keyword">new</span> Query(Criteria.where(<span class="string">"id"</span>).is(id)), User.class);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建Service，进行业务调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.mongo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.riky.mongo.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> com.riky.mongo.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">* <span class="doctag">@create</span> 2018-03-21 14:36:19</span></span><br><span class="line"><span class="comment">* <span class="doctag">@desciption</span>:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao dao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById_UserDb1</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  dao.findUserById_UserDb1(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById_UserDb2</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  dao.findUserById_UserDb2(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建单元测试用例读取用户信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.mongo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.riky.mongo.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">* <span class="doctag">@create</span> 2018-03-21 15:33:18</span></span><br><span class="line"><span class="comment">* <span class="doctag">@desciption</span>:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUserById_UserDb1Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      User user = userService.findUserById_UserDb1(<span class="string">"58d6735d84ae4de8b2ab42b3"</span>)</span><br><span class="line">      System.out.println(<span class="string">"user: "</span> + user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUserById_UserDb2Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       User user = userService.findUserById_UserDb2(<span class="string">"58d8694f84aedcc7676738e5"</span>);</span><br><span class="line">       System.out.println(<span class="string">"user: "</span> + user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2018/03/21/SpringBoot集成LDAP实现登录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/21/SpringBoot集成LDAP实现登录/" itemprop="url">Spring Boot集成LDAP实现登录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-21T15:42:00+08:00">
                2018-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/03/21/SpringBoot集成LDAP实现登录/" class="leancloud_visitors" data-flag-title="Spring Boot集成LDAP实现登录">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="LDAP简介"><a href="#LDAP简介" class="headerlink" title="LDAP简介"></a>LDAP简介</h2><ul>
<li><p>LDAP（轻量级目录访问协议，Lightweight Directory Access Protocol)是实现提供被称为目录服务的信息服务。</p>
<p>目录服务是一种特殊的数据库系统，其专门针对读取，浏览和搜索操作进行了特定的优化。目录一般用来包含描述性的，基于属性的信息并支持精细复杂的过滤能力。目录一般不支持通用数据库针对大量更新操作操作需要的复杂的事务管理或回卷策略。而目录服务的更新则一般都非常简单。这种目录可以存储包括个人信息、web链结、jpeg图像等各种信息。为了访问存储在目录中的信息，就需要使用运行在TCP/IP 之上的访问协议—LDAP。</p>
<p>LDAP目录中的信息是是按照树型结构组织，具体信息存储在条目(entry)的数据结构中。条目相当于关系数据库中表的记录；条目是具有区别名DN （Distinguished Name）的属性（Attribute），DN是用来引用条目的，DN相当于关系数据库表中的关键字（Primary Key）。属性由类型（Type）和一个或多个值（Values）组成，相当于关系数据库中的字段（Field）由字段名和数据类型组成，只是为了方便检索的需要，LDAP中的Type可以有多个Value，而不是关系数据库中为降低数据的冗余性要求实现的各个域必须是不相关的。LDAP中条目的组织一般按照地理位置和组织关系进行组织，非常的直观。LDAP把数据存放在文件中，为提高效率可以使用基于索引的文件数据库，而不是关系数据库。类型的一个例子就是mail，其值将是一个电子邮件地址。</p>
<p>LDAP的信息是以树型结构存储的，在树根一般定义国家(c=CN)或域名(dc=com)，在其下则往往定义一个或多个组织 (organization)(o=Acme)或组织单元(organizational units) (ou=People)。一个组织单元可能包含诸如所有雇员、大楼内的所有打印机等信息。此外，LDAP支持对条目能够和必须支持哪些属性进行控制，这是有一个特殊的称为对象类别(objectClass)的属性来实现的。该属性的值决定了该条目必须遵循的一些规则，其规定了该条目能够及至少应该包含哪些属性。例如：inetorgPerson对象类需要支持sn(surname)和cn(common name)属性，但也可以包含可选的如邮件，电话号码等属性。</p>
</li>
</ul>
<h2 id="LDAP简称对应"><a href="#LDAP简称对应" class="headerlink" title="LDAP简称对应"></a>LDAP简称对应</h2>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">o：organization（组织-公司）</span><br><span class="line">ou：organization unit（组织单元-部门）</span><br><span class="line">c：countryName（国家）</span><br><span class="line">dc：domainComponent（域名）</span><br><span class="line">sn：surname（姓氏）</span><br><span class="line">cn：common name（常用名称）</span><br><span class="line">sAMAccountName:英文名(RTX账号,唯一)</span><br><span class="line">userPrincipalName:登陆用户名 和 英文名一致</span><br></pre></td></tr></table></figure>
<p>以上内容参考自：<a href="https://www.cnblogs.com/obpm/archive/2010/08/28/1811065.html" target="_blank" rel="noopener">LDAP快速入门</a></p>
<h2 id="登录实现"><a href="#登录实现" class="headerlink" title="登录实现"></a>登录实现</h2><ul>
<li>创建一个基础的Spring Boot项目</li>
<li><p>在pom.xml中引入Spring Ldap依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-ldap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>spring-boot-starter-data-ldap是Spring Boot封装的对LDAP自动化配置的实现，它是基于spring-data-ldap来对LDAP服务端进行具体操作的。</p>
</li>
<li><p>在src/main/resources/application.properties中添加以下配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ldap config</span><br><span class="line">#连接地址</span><br><span class="line">spring.ldap.urls=ldap://ldap.rikylee.com:389</span><br><span class="line">spring.ldap.username=rikylee</span><br><span class="line">spring.ldap.password=rikylee</span><br><span class="line">spring.ldap.base=ou=employee,dc=rikylee,dc=com</span><br><span class="line">spring.ldap.domainName=@rikylee.com</span><br><span class="line">spring.ldap.referral=follow</span><br></pre></td></tr></table></figure>
<p>以上参数为ldap的相关连接配置。</p>
</li>
<li><p>建立一个用户对象，用于实体关系的映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.ldap.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="comment">//用户名</span></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="comment">//登录名</span></span><br><span class="line">  <span class="keyword">private</span> String sAMAccountName;</span><br><span class="line">  <span class="comment">//所属组列表</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;String&gt; role;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getsAMAccountName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sAMAccountName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setsAMAccountName</span><span class="params">(String sAMAccountName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sAMAccountName = sAMAccountName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getRole</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRole</span><span class="params">(List&lt;String&gt; role)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.role = role;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        stringBuffer.append(<span class="string">"name:"</span>+name+<span class="string">","</span>);</span><br><span class="line">        stringBuffer.append(<span class="string">"sAMAccountName:"</span>+sAMAccountName);</span><br><span class="line">        <span class="keyword">if</span>(role!=<span class="keyword">null</span> &amp;&amp; role.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            stringBuffer.append(<span class="string">",role:"</span>+String.join(<span class="string">","</span>,role));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stringBuffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>建立一个Service，实现登录授权，已经用户信息的查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.ldap.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.riky.ldap.entity.Person;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ldap.core.AttributesMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ldap.core.LdapTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ldap.support.LdapUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.Attributes;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.DirContext;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.ldap.query.LdapQueryBuilder.query;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LdapPersonService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LdapTemplate ldapTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.ldap.domainName&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String ldapDomainName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">findByUsername</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="comment">//这里注意用户名加域名后缀  userDn格式：abcd@rikylee.com</span></span><br><span class="line">        String userDn = username + ldapDomainName;</span><br><span class="line">        <span class="comment">//使用用户名、密码验证域用户</span></span><br><span class="line">        DirContext ctx = ldapTemplate.getContextSource().getContext(userDn, password);</span><br><span class="line">        <span class="comment">//如果验证成功根据sAMAccountName属性查询用户名和用户所属的组</span></span><br><span class="line">        Person person = ldapTemplate.search(query().where(<span class="string">"objectclass"</span>).is(<span class="string">"person"</span>).and(<span class="string">"sAMAccountName"</span>).is(username), <span class="keyword">new</span> AttributesMapper&lt;Person&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Person <span class="title">mapFromAttributes</span><span class="params">(Attributes attributes)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">                Person person = <span class="keyword">new</span> Person();</span><br><span class="line">                person.setName(attributes.get(<span class="string">"cn"</span>).get().toString());</span><br><span class="line">                person.setsAMAccountName(attributes.get(<span class="string">"sAMAccountName"</span>).get().toString());</span><br><span class="line"></span><br><span class="line">                String memberOf = attributes.get(<span class="string">"memberOf"</span>).toString().replace(<span class="string">"memberOf: "</span>, <span class="string">""</span>);</span><br><span class="line">                List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                String[] roles = memberOf.split(<span class="string">","</span>);</span><br><span class="line">                <span class="keyword">for</span> (String role : roles) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.startsWithIgnoreCase(role.trim(), <span class="string">"CN="</span>)) &#123;</span><br><span class="line">                        list.add(role.trim().replace(<span class="string">"CN="</span>, <span class="string">""</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                person.setRole(list);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> person;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).get(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//关闭ldap连接</span></span><br><span class="line">        LdapUtils.closeContext(ctx);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建单元测试用例测试登录以及读取用户信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.riky.ldap.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.riky.ldap.entity.Person;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Riky Li</span></span><br><span class="line"><span class="comment">* <span class="doctag">@create</span> 2018-03-20 10:33:18</span></span><br><span class="line"><span class="comment">* <span class="doctag">@desciption</span>:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LdapPersonServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LdapPersonService ldapPersonService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByUsernameTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Person person = ldapPersonService.findByUsername(<span class="string">"rikylee"</span>, <span class="string">"rikylee"</span>);</span><br><span class="line">            System.out.println(<span class="string">"person: "</span> + person.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如出现以下Exception</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">error code 49</span><br><span class="line"></span><br><span class="line">==========================================================================</span><br><span class="line"></span><br><span class="line">javax.naming.AuthenticationException: [LDAP: error code 49 - 80090308: LdapErr: DSID-0C090334, comment: AcceptSecurityContext error, data 52e, vece</span><br></pre></td></tr></table></figure>
<p>原因：用户名或密码错误</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2018/03/08/带宽计算/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/08/带宽计算/" itemprop="url">网站需要带宽计算</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-08T10:26:00+08:00">
                2018-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络/" itemprop="url" rel="index">
                    <span itemprop="name">网络</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/03/08/带宽计算/" class="leancloud_visitors" data-flag-title="网站需要带宽计算">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="带宽计算"><a href="#带宽计算" class="headerlink" title="带宽计算"></a>带宽计算</h1><ul>
<li><p>假设网站每天要承受100万PV的访问量，计算带宽涉及到两个指标（峰值流量和页面平均大小），带宽单位为bps（bit/s）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、假设峰值流量为平均流量的5倍</span><br><span class="line">2、假设每次访问的平均页面的大小为100KB左右</span><br><span class="line"></span><br><span class="line">1B=8b ------------------------ 1B/s=8b/s(1Bps=8bps)</span><br><span class="line">1KB=1024B -------------------- 1KB/s=1024B/s</span><br><span class="line">1MB=1024KB ------------------- 1MB/s=1024KB/s</span><br></pre></td></tr></table></figure>
<p>100万pv访问量一天平均分布，折合每秒大约访问12次，页面大小为字节(Byte),总共访问页面大小就是12<em>100KB=1200KB,1Byte=8bit,则1200KB=9600Kb，9600Kb/1024大约9Mb/s(9Mbps)，我们网站在峰值流量时一定要保持正常访问，则真实带宽应该在9M</em>5=45Mbps左右。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2018/02/07/openssh无密登录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/openssh无密登录/" itemprop="url">OpenSSH 实现基于PublicKey认证实现无密登录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T16:12:00+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/07/openssh无密登录/" class="leancloud_visitors" data-flag-title="OpenSSH 实现基于PublicKey认证实现无密登录">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>准备两台服务器A、B，其中A(192.168.1.100)为客户端，B(192.168.1.101)为服务端，实现A服务器通过公钥（publickey）认证，无密码登录B服务器</p>
<ul>
<li><p>在A服务器上生成用于认证的公钥，默认使用rsa加密 <code>ssh-keygen</code>，然后一直按回车键</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">c7:35:8f:c1:9f:2c:cb:32:29:2d:ac:57:f4:90:d9:70 root@localhost</span><br><span class="line">The key<span class="string">'s randomart image is:</span></span><br><span class="line"><span class="string">+--[ RSA 2048]----+</span></span><br><span class="line"><span class="string">|                 |</span></span><br><span class="line"><span class="string">|          ..E    |</span></span><br><span class="line"><span class="string">|           *=    |</span></span><br><span class="line"><span class="string">|         .=..B . |</span></span><br><span class="line"><span class="string">|        S.ooo =  |</span></span><br><span class="line"><span class="string">|       . o.o.o   |</span></span><br><span class="line"><span class="string">|        +.= o    |</span></span><br><span class="line"><span class="string">|       ..o o     |</span></span><br><span class="line"><span class="string">|      ..         |</span></span><br><span class="line"><span class="string">+-----------------+</span></span><br></pre></td></tr></table></figure>
<p>即可在<code>/root/.ssh</code>目录下找到 id_rsa,id_rsa.pub两个文件，id_rsb.pub就是我们本次操作需要用到的公钥。</p>
</li>
<li><p>拷贝A服务器上生成的公钥到B服务器上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]$ ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.1.101</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: <span class="string">"~/.ssh/id_rsa.pub"</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to <span class="built_in">log</span> <span class="keyword">in</span> with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="keyword">if</span> you are prompted now it is to install the new keys</span><br><span class="line">root@10.3.175.53<span class="string">'s password:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Number of key(s) added: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Now try logging into the machine, with:   "ssh '</span>root@192.168.1.101<span class="string">'"</span></span><br><span class="line"><span class="string">and check to make sure that only the key(s) you wanted were added.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>SSH登陆B(192.168.1.101)服务器，查看<code>~/.ssh/authorized_keys</code>是否存在</p>
</li>
<li><p>修改<code>/etc/ssh/sshd_config</code>文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS 7.4 #PubkeyAuthentication yes 前面的#去掉即可</span></span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS 7.4以前版本 把以下几项前面的#去掉</span></span><br><span class="line"><span class="comment">#RSAAuthentication yes</span></span><br><span class="line">RSAAuthentication yes</span><br><span class="line"><span class="comment">#PubkeyAuthentication yes</span></span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line"><span class="comment">#AuthorizedKeysFile     .ssh/authorized_keys</span></span><br><span class="line">AuthorizedKeysFile      .ssh/authorized_keys</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启B(192.168.1.101)服务器sshd进程,根据系统版本，以下三个命令都可以达到相同的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/sshd restart</span><br><span class="line"></span><br><span class="line">service sshd restart</span><br><span class="line"></span><br><span class="line">systemctl restart sshd.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>在A(192.168.1.100)服务器上使用 <code>ssh root@192.168.1.101</code>,即可直接登录B(192.168.1.101)服务器。</p>
</li>
<li><p>填坑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1、关闭B(192.168.1.101)服务器上的selinux sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">2、如果要B(192.168.1.101)服务器用户不是root用户，请重新在A(192.168.1.100)服务器上执行 ssh-copy-id -i ~/.ssh/id_rsa.pub username@192.168.1.101,并且保证该用户的根目录,username/.ssh目录，以及authorized_keys文件的权限同下面一致</span><br><span class="line"></span><br><span class="line">[username@localhost home]$ ll</span><br><span class="line">total 4</span><br><span class="line">drwx------. 14 username username 4096 Feb  7 11:12 username</span><br><span class="line"></span><br><span class="line">[username@localhost ~]$ ll</span><br><span class="line">drwx------.  2 username username   48 Feb  7 15:30 .ssh</span><br><span class="line"></span><br><span class="line">[username@localhost ~]$ ll -alh .ssh/</span><br><span class="line">total 28K</span><br><span class="line">drwx------.  2 username username   48 Feb  7 15:30 .</span><br><span class="line">drwx------. 14 username username 4.0K Feb  7 11:12 ..</span><br><span class="line">-rw-------   1 username username  399 Feb  7 15:30 authorized_keys</span><br><span class="line">-rw-r--r--.  1 username username  19K Feb  7 11:13 known_hosts</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2018/02/06/pyenv管理多版本python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/06/pyenv管理多版本python/" itemprop="url">CentOS 7 上 pyenv 实现python多版本管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-06T14:30:00+08:00">
                2018-02-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/06/pyenv管理多版本python/" class="leancloud_visitors" data-flag-title="CentOS 7 上 pyenv 实现python多版本管理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>获取pyenv <code>git clone https://github.com/pyenv/pyenv.git ~/.pyenv</code></p>
</li>
<li><p>设置环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export PYENV_ROOT="$HOME/.pyenv"'</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="$PYENV_ROOT/bin:$PATH"'</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">'if command -v pyenv 1&gt;/dev/null 2&gt;&amp;1; then\n  eval "$(pyenv init -)"\nfi'</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启当前shell <code>exec &quot;$SHELL&quot;</code></p>
</li>
<li><p>安装依赖，防止安装其他版本的Python时报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc gcc-c++ readline readline-devel readline-static -y</span><br><span class="line">yum install openssl openssl-devel openssl-static -y</span><br><span class="line">yum install sqlite-devel -y</span><br><span class="line">yum install bzip2-devel bzip2-libs -y</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前系统默认Python版本命令 <code>python --version</code></p>
</li>
<li><p>pyenv的用法以及部分相关命令详解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pyenv 命令使用规则如下：pyenv &lt;command&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line">//查看可安装的版本列表</span><br><span class="line">pyenv install -list</span><br><span class="line">//安装指定的Python版本,例如3.6.4</span><br><span class="line">pyenv install 3.6.4</span><br><span class="line">//切换当前目录的版本号为3.6.4</span><br><span class="line">pyenv local 3.6.4</span><br><span class="line">//切换全局目录Python版本号为3.6.4</span><br><span class="line">pyenv global 3.6.4</span><br><span class="line">//切换全局目录Python版本号系统默认版本</span><br><span class="line">pyenv global system</span><br><span class="line">//刷新shims</span><br><span class="line">pyenv rehash</span><br></pre></td></tr></table></figure>
</li>
<li><p>pyenv的部分命令说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">commands      列出所有pyenv可用命令</span><br><span class="line">local         设置或列出当前环境下Python的版本号</span><br><span class="line">global        设置或列出全局环境下Python的版本号</span><br><span class="line">shell         设置或列出Shell环境下Python的版本号</span><br><span class="line">install       安装指定版本的Python</span><br><span class="line">uninstall     卸载指定版本的Python</span><br><span class="line">rehash        重新加载pyenv的shims路径，安装完python版本之后执行该命令</span><br><span class="line">version       展示当前python版本号及其路径</span><br><span class="line">versions      列出所有pyenv已安装的并且可用的Python版本</span><br></pre></td></tr></table></figure>
<p>其他命令可通过<code>pyenv --help</code>获取帮助文档，<code>pyenv help &lt;command&gt;</code>可以获取指定命令的详细用法.</p>
</li>
</ul>
<p>以上设置仅生效于当前操作用户，其他用户无效。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2018/01/20/open-falcon环境搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/20/open-falcon环境搭建/" itemprop="url">小米开源监控框架open falcon 入坑之环境搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-20T11:00:40+08:00">
                2018-01-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/01/20/open-falcon环境搭建/" class="leancloud_visitors" data-flag-title="小米开源监控框架open falcon 入坑之环境搭建">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="切换源为阿里源-非必须，个人习惯"><a href="#切换源为阿里源-非必须，个人习惯" class="headerlink" title="切换源为阿里源(非必须，个人习惯)"></a>切换源为阿里源(非必须，个人习惯)</h2><ul>
<li><p>备份默认的yum <code>mv /etc/yum.repos.d /etc/yum.repos.d.backup</code></p>
</li>
<li><p>设置新的yum目录 <code>mkdir /etc/yum.repos.d</code></p>
</li>
<li><p>下载阿里yum配置到该目录中 <code>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</code></p>
</li>
<li><p>重建缓存</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum clean all</span><br><span class="line">sudo yum makecache</span><br></pre></td></tr></table></figure>
<ul>
<li>升级所有包（改变软件设置和系统设置，系统版本内核都升级，故需要几分钟耐心等待<code>yum update -y</code></li>
</ul>
<h2 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h2><ul>
<li><p>使用yum命令安装 <code>sudo yum install -y git</code></p>
</li>
<li><p>安装结束后安全起见，确认是否满足官方要求的Git &gt;= 1.7.5 <code>git version</code></p>
</li>
</ul>
<h2 id="安装go语言环境"><a href="#安装go语言环境" class="headerlink" title="安装go语言环境"></a>安装go语言环境</h2><ul>
<li>因为官方yum和阿里yum都没有go的安装包，故只能通过fedora的epel仓库来安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line">yum install golang -y</span><br></pre></td></tr></table></figure>
<ul>
<li>安装结束后安全起见，确认是否满足官方要求的Go &gt;= 1.6 <code>go version</code></li>
</ul>
<h2 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h2><ul>
<li><p>由于部署go时已经安装了epel，故直接执行下面的安装命令（如果没有装epel，会提示No package redis available，也就是没有安装包可用，因为官方yum和阿里yum都没有redis，故只能通过fedora的epel仓库来安装） <code>yum install redis -y</code></p>
</li>
<li><p>启动redis  <code>sudo systemctl start redis</code></p>
</li>
<li><p>设置redis开机启动 <code>sudo systemctl enable redis</code></p>
</li>
<li><p>可以用下面的语句查看redis是否开启 <code>sudo systemctl status redis</code></p>
</li>
</ul>
<h2 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h2><ul>
<li><p>Centos7自带的mysql是mariadb ,我们可以通过如下命令查看 <code>yum search mysql|tac</code></p>
</li>
<li><p>开始安装mariadb <code>sudo yum -y install mariadb mariadb-server</code></p>
</li>
<li><p>设置开机自启动mysql <code>sudo systemctl enable mariadb.service</code></p>
</li>
<li><p>启动mysql   <code>sudo systemctl start mariadb.service</code></p>
</li>
<li><p>初始化mysql数据库，并配置root用户密码 <code>sudo mysql_secure_installation</code></p>
</li>
</ul>
<h2 id="安装open-falcon"><a href="#安装open-falcon" class="headerlink" title="安装open falcon"></a>安装open falcon</h2><p>获取open falcon 二进制包，有两种方式</p>
<ul>
<li><p>方式一：下载源代码，然后手动编译 <code>go env</code> 获取GOPATH的位置</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd $GOPATH &amp;&amp; mkdir src/github.com/open-falcon &amp;&amp; cd src/github.com/open-falcon</span><br><span class="line"></span><br><span class="line">git clone https://github.com/open-falcon/falcon-plus.git</span><br><span class="line"></span><br><span class="line">make all</span><br><span class="line"></span><br><span class="line">make pack</span><br></pre></td></tr></table></figure>
<p>  以上步骤完成之后，在$GOPATH/src/github.com/open-falcon/falcon-plus 目录下，可以找到open-falcon-v0.2.1.tar.gz文件</p>
</li>
<li><p>方式二：下载 open falcon 二进制包 <code>wget https://github.com/open-falcon/falcon-plus/releases/download/v0.2.1/open-falcon-v0.2.1.tar.gz</code></p>
</li>
<li><p>创建工作目录，并解压二进制包到工作目录下 <code>cd ~ &amp;&amp; mkdir open-falcon &amp;&amp; tar xf open-falcon-v0.2.1.tar.gz -C open-falcon</code></p>
</li>
<li><p>初始化mysql表结构</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cd ~ &amp;&amp; git clone https://github.com/open-falcon/falcon-plus.git</span><br><span class="line"></span><br><span class="line">cd ./falcon-plus/scripts/mysql/db_schema/</span><br><span class="line"></span><br><span class="line">mysql -h 127.0.0.1 -u root -p &lt; 1_uic-db-schema.sql</span><br><span class="line"></span><br><span class="line">mysql -h 127.0.0.1 -u root -p &lt; 2_portal-db-schema.sql</span><br><span class="line"></span><br><span class="line">mysql -h 127.0.0.1 -u root -p &lt; 3_dashboard-db-schema.sql</span><br><span class="line"></span><br><span class="line">mysql -h 127.0.0.1 -u root -p &lt; 4_graph-db-schema.sql</span><br><span class="line"></span><br><span class="line">mysql -h 127.0.0.1 -u root -p &lt; 5_alarms-db-schema.sql</span><br><span class="line"></span><br><span class="line">cd ~</span><br><span class="line"></span><br><span class="line">rm -rf ./falcon-plus/</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Agent</p>
<p>  agent用于采集机器负载监控指标，比如cpu.idle、load.1min、disk.io.util等等，每隔60秒push给Transfer。agent与Transfer建立了长连接，数据发送速度比较快，agent提供了一个http接口/v1/push用于接收用户手工push的一些数据，然后通过长连接迅速转发给Transfer。 <code>vi ~/open-falcon/agent/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "debug": true,  # 控制一些debug信息的输出，生产环境通常设置为false</span><br><span class="line">    "hostname": "", # agent采集了数据发给transfer，endpoint就设置为了hostname，默认通过`hostname`获取，如果配置中配置了hostname，就用配置中的</span><br><span class="line">    "ip": "", # agent与hbs心跳的时候会把自己的ip地址发给hbs，agent会自动探测本机ip，如果不想让agent自动探测，可以手工修改该配置</span><br><span class="line">    "plugin": &#123;</span><br><span class="line">        "enabled": false, # 默认不开启插件机制</span><br><span class="line">        "dir": "./plugin",  # 把放置插件脚本的git repo clone到这个目录</span><br><span class="line">        "git": "https://github.com/open-falcon/plugin.git", # 放置插件脚本的git repo地址</span><br><span class="line">        "logs": "./logs" # 插件执行的log，如果插件执行有问题，可以去这个目录看log</span><br><span class="line">    &#125;,</span><br><span class="line">    "heartbeat": &#123;</span><br><span class="line">        "enabled": true,  # 此处enabled要设置为true</span><br><span class="line">        "addr": "127.0.0.1:6030", # hbs的地址，端口是hbs的rpc端口</span><br><span class="line">        "interval": 60, # 心跳周期，单位是秒</span><br><span class="line">        "timeout": 1000 # 连接hbs的超时时间，单位是毫秒</span><br><span class="line">    &#125;,</span><br><span class="line">    "transfer": &#123;</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "addrs": [</span><br><span class="line">            <span class="string">"127.0.0.1:18433"</span></span><br><span class="line">        ],  # transfer的地址，端口是transfer的rpc端口, 可以支持写多个transfer的地址，agent会保证HA</span><br><span class="line">        "interval": 60, # 采集周期，单位是秒，即agent一分钟采集一次数据发给transfer</span><br><span class="line">        "timeout": 1000 # 连接transfer的超时时间，单位是毫秒</span><br><span class="line">    &#125;,</span><br><span class="line">    "http": &#123;</span><br><span class="line">        "enabled": true,  # 是否要监听http端口</span><br><span class="line">        "listen": ":1988",</span><br><span class="line">        "backdoor": false</span><br><span class="line">    &#125;,</span><br><span class="line">    "collector": &#123;</span><br><span class="line">        "ifacePrefix": ["eth", "em"], # 默认配置只会采集网卡名称前缀是eth、em的网卡流量，配置为空就会采集所有的，lo的也会采集。可以从/proc/net/dev看到各个网卡的流量信息</span><br><span class="line">        "mountPoint": []</span><br><span class="line">    &#125;,</span><br><span class="line">    "default_tags": &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    "ignore": &#123;  # 默认采集了200多个metric，可以通过ignore设置为不采集</span><br><span class="line">        "cpu.busy": true,</span><br><span class="line">        "df.bytes.free": true,</span><br><span class="line">        "df.bytes.total": true,</span><br><span class="line">        "df.bytes.used": true,</span><br><span class="line">        "df.bytes.used.percent": true,</span><br><span class="line">        "df.inodes.total": true,</span><br><span class="line">        "df.inodes.free": true,</span><br><span class="line">        "df.inodes.used": true,</span><br><span class="line">        "df.inodes.used.percent": true,</span><br><span class="line">        "mem.memtotal": true,</span><br><span class="line">        "mem.memused": true,</span><br><span class="line">        "mem.memused.percent": true,</span><br><span class="line">        "mem.memfree": true,</span><br><span class="line">        "mem.swaptotal": true,</span><br><span class="line">        "mem.swapused": true,</span><br><span class="line">        "mem.swapfree": true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  启动agent命令 <code>~/open-falcon/open-falcon start agent</code></p>
<p>  停止agent命令 <code>~/open-falcon/open-falcon stop agent</code></p>
<p>  监控agent命令 <code>~/open-falcon/open-falcon monitor agent</code></p>
<p>  防火墙开放1988端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=1988/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>  浏览器访问<a href="http://ip:1988" target="_blank" rel="noopener">http://ip:1988</a> 端口,即可看到agent采集到的数据</p>
<p>  <img src="https://raw.githubusercontent.com/aiguanglee/program-notes/master/screenshots/agent_pic.png" alt="agent采集数据"></p>
</li>
<li><p>配置Transfer</p>
<p>  transfer是数据转发服务。它接收agent上报的数据，然后按照哈希规则进行数据分片、并将分片后的数据分别push给graph&amp;judge等组件。<code>vi ~/open-falcon/transfer/config/cfg.json</code></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"minStep"</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:6060"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"rpc"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:8433"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"socket"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:4444"</span>,</span><br><span class="line">        <span class="attr">"timeout"</span>: <span class="number">3600</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"judge"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"batch"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"connTimeout"</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">"callTimeout"</span>: <span class="number">5000</span>,</span><br><span class="line">        <span class="attr">"maxConns"</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="attr">"maxIdle"</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="attr">"replicas"</span>: <span class="number">500</span>,</span><br><span class="line">        <span class="attr">"cluster"</span>: &#123;</span><br><span class="line">            <span class="attr">"judge-00"</span> : <span class="string">"127.0.0.1:6080"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"graph"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"batch"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"connTimeout"</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">"callTimeout"</span>: <span class="number">5000</span>,</span><br><span class="line">        <span class="attr">"maxConns"</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="attr">"maxIdle"</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="attr">"replicas"</span>: <span class="number">500</span>,</span><br><span class="line">        <span class="attr">"cluster"</span>: &#123;</span><br><span class="line">            <span class="attr">"graph-00"</span> : <span class="string">"127.0.0.1:6070"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"tsdb"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"batch"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"connTimeout"</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">"callTimeout"</span>: <span class="number">5000</span>,</span><br><span class="line">        <span class="attr">"maxConns"</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="attr">"maxIdle"</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="attr">"retry"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"127.0.0.1:8088"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  配置说明</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">debug: true/false, 如果为true，日志中会打印debug信息</span><br><span class="line"></span><br><span class="line">minStep: 30, 允许上报的数据最小间隔，默认为30秒</span><br><span class="line"></span><br><span class="line">http</span><br><span class="line">    - enabled: true/false, 表示是否开启该http端口，该端口为控制端口，主要用来对transfer发送控制命令、统计命令、debug命令等</span><br><span class="line">    - listen: 表示监听的http端口</span><br><span class="line"></span><br><span class="line">rpc</span><br><span class="line">    - enabled: true/false, 表示是否开启该jsonrpc数据接收端口, Agent发送数据使用的就是该端口</span><br><span class="line">    - listen: 表示监听的http端口</span><br><span class="line"></span><br><span class="line">socket #即将被废弃,请避免使用</span><br><span class="line">    - enabled: true/false, 表示是否开启该telnet方式的数据接收端口，这是为了方便用户一行行的发送数据给transfer</span><br><span class="line">    - listen: 表示监听的http端口</span><br><span class="line"></span><br><span class="line">judge</span><br><span class="line">    - enabled: true/false, 表示是否开启向judge发送数据</span><br><span class="line">    - batch: 数据转发的批量大小，可以加快发送速度，建议保持默认值</span><br><span class="line">    - connTimeout: 单位是毫秒，与后端建立连接的超时时间，可以根据网络质量微调，建议保持默认</span><br><span class="line">    - callTimeout: 单位是毫秒，发送数据给后端的超时时间，可以根据网络质量微调，建议保持默认</span><br><span class="line">    - pingMethod: 后端提供的ping接口，用来探测连接是否可用，必须保持默认</span><br><span class="line">    - maxConns: 连接池相关配置，最大连接数，建议保持默认</span><br><span class="line">    - maxIdle: 连接池相关配置，最大空闲连接数，建议保持默认</span><br><span class="line">    - replicas: 这是一致性hash算法需要的节点副本数量，建议不要变更，保持默认即可</span><br><span class="line">    - cluster: key-value形式的字典，表示后端的judge列表，其中key代表后端judge名字，value代表的是具体的ip:port</span><br><span class="line"></span><br><span class="line">graph</span><br><span class="line">    - enabled: true/false, 表示是否开启向graph发送数据</span><br><span class="line">    - batch: 数据转发的批量大小，可以加快发送速度，建议保持默认值</span><br><span class="line">    - connTimeout: 单位是毫秒，与后端建立连接的超时时间，可以根据网络质量微调，建议保持默认</span><br><span class="line">    - callTimeout: 单位是毫秒，发送数据给后端的超时时间，可以根据网络质量微调，建议保持默认</span><br><span class="line">    - pingMethod: 后端提供的ping接口，用来探测连接是否可用，必须保持默认</span><br><span class="line">    - maxConns: 连接池相关配置，最大连接数，建议保持默认</span><br><span class="line">    - maxIdle: 连接池相关配置，最大空闲连接数，建议保持默认</span><br><span class="line">    - replicas: 这是一致性hash算法需要的节点副本数量，建议不要变更，保持默认即可</span><br><span class="line">    - cluster: key-value形式的字典，表示后端的graph列表，其中key代表后端graph名字，value代表的是具体的ip:port(多个地址用逗号隔开, transfer会将同一份数据发送至各个地址，利用这个特性可以实现数据的多重备份)</span><br><span class="line"></span><br><span class="line">tsdb</span><br><span class="line">    - enabled: true/false, 表示是否开启向open tsdb发送数据</span><br><span class="line">    - batch: 数据转发的批量大小，可以加快发送速度</span><br><span class="line">    - connTimeout: 单位是毫秒，与后端建立连接的超时时间，可以根据网络质量微调，建议保持默认</span><br><span class="line">    - callTimeout: 单位是毫秒，发送数据给后端的超时时间，可以根据网络质量微调，建议保持默认</span><br><span class="line">    - maxConns: 连接池相关配置，最大连接数，建议保持默认</span><br><span class="line">    - maxIdle: 连接池相关配置，最大空闲连接数，建议保持默认</span><br><span class="line">    - retry: 连接后端的重试次数和发送数据的重试次数</span><br><span class="line">    - address: tsdb地址或者tsdb集群vip地址, 通过tcp连接tsdb.</span><br></pre></td></tr></table></figure>
<p>  启动transfer命令 <code>~/open-falcon/open-falcon start transfer</code></p>
<p>  停止transfer命令 <code>~/open-falcon/open-falcon stop transfer</code></p>
<p>  监控transfer命令 <code>~/open-falcon/open-falcon monitor transfer</code></p>
<p>  防火墙开放6060、8433端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=6060/tcp --permanent</span><br><span class="line">sudo firewall-cmd --add-port=8433/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>  校验服务,这里假定服务开启了6060的http监听端口。检验结果为ok表明服务正常启动。<code>curl -s &quot;127.0.0.1:6060/health&quot;</code></p>
<p>  部署完成transfer组件后，请修改agent的配置，使其指向正确的transfer地址。在安装完graph和judge后，请修改transfer的相应配置、使其能够正确寻址到这两个组件。</p>
</li>
<li><p>配置Graph</p>
<p>  graph是存储绘图数据的组件。graph组件 接收transfer组件推送上来的监控数据，同时处理api组件的查询请求、返回绘图数据。<code>vi ~/open-falcon/graph/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "debug": false, //true or false, 是否开启debug日志</span><br><span class="line">    "http": &#123;</span><br><span class="line">        "enabled": true, //true or false, 表示是否开启该http端口，该端口为控制端口，主要用来对graph发送控制命令、统计命令、debug命令</span><br><span class="line">        "listen": "0.0.0.0:6071" //表示监听的http端口</span><br><span class="line">    &#125;,</span><br><span class="line">    "rpc": &#123;</span><br><span class="line">        "enabled": true, //true or false, 表示是否开启该rpc端口，该端口为数据接收端口</span><br><span class="line">        "listen": "0.0.0.0:6070" //表示监听的rpc端口</span><br><span class="line">    &#125;,</span><br><span class="line">    "rrd": &#123;</span><br><span class="line">        "storage": "./data/6070" // 历史数据的文件存储路径（如有必要，请修改为合适的路）</span><br><span class="line">    &#125;,</span><br><span class="line">    "db": &#123;</span><br><span class="line">        "dsn": "root:password@tcp(127.0.0.1:3306)/graph?loc=Local&amp;parseTime=true", //MySQL的连接信息，默认用户名是root，密码为空，host为127.0.0.1，database为graph（如有必要，请修改)</span><br><span class="line">        "maxIdle": 4  //MySQL连接池配置，连接池允许的最大连接数，保持默认即可</span><br><span class="line">    &#125;,</span><br><span class="line">    "callTimeout": 5000,  //RPC调用超时时间，单位ms</span><br><span class="line">    "migrate": &#123;  //扩容graph时历史数据自动迁移</span><br><span class="line">        "enabled": false,  //true or false, 表示graph是否处于数据迁移状态</span><br><span class="line">        "concurrency": 2, //数据迁移时的并发连接数，建议保持默认</span><br><span class="line">        "replicas": 500, //这是一致性hash算法需要的节点副本数量，建议不要变更，保持默认即可（必须和transfer的配置中保持一致）</span><br><span class="line">        "cluster": &#123; //未扩容前老的graph实例列表</span><br><span class="line">            "graph-00" : "127.0.0.1:6070"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  启动graph命令 <code>~/open-falcon/open-falcon start graph</code></p>
<p>  停止graph命令 <code>~/open-falcon/open-falcon stop graph</code></p>
<p>  监控graph命令 <code>~/open-falcon/open-falcon monitor graph</code></p>
<p>  防火墙开放6071、6070端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=6070/tcp --permanent</span><br><span class="line">sudo firewall-cmd --add-port=6071/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>  部署完graph组件后，请修改transfer和api的配置，使这两个组件可以寻址到graph。</p>
</li>
<li><p>配置API</p>
<p>  api组件，提供统一的restAPI操作接口。比如：api组件接收查询请求，根据一致性哈希算法去相应的graph实例查询不同metric的数据，然后汇总拿到的数据，最后统一返回给用户。<code>vi ~/open-falcon/api/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"log_level"</span>: <span class="string">"debug"</span>,</span><br><span class="line">    "db": &#123;  //数据库相关的连接配置信息</span><br><span class="line">        "faclon_portal": "root:@tcp(127.0.0.1:3306)/falcon_portal?charset=utf8&amp;parseTime=True&amp;loc=Local",</span><br><span class="line">        "graph": "root:password@tcp(127.0.0.1:3306)/graph?charset=utf8&amp;parseTime=True&amp;loc=Local",</span><br><span class="line">        "uic": "root:password@tcp(127.0.0.1:3306)/uic?charset=utf8&amp;parseTime=True&amp;loc=Local",</span><br><span class="line">        "dashboard": "root:password@tcp(127.0.0.1:3306)/dashboard?charset=utf8&amp;parseTime=True&amp;loc=Local",</span><br><span class="line">        "alarms": "root:password@tcp(127.0.0.1:3306)/alarms?charset=utf8&amp;parseTime=True&amp;loc=Local",</span><br><span class="line">        "db_bug": true</span><br><span class="line">    &#125;,</span><br><span class="line">    "graphs": &#123;  // graph模块的部署列表信息</span><br><span class="line">        "cluster": &#123;</span><br><span class="line">            "graph-00": "127.0.0.1:6070"</span><br><span class="line">        &#125;,</span><br><span class="line">        "max_conns": 100,</span><br><span class="line">        "max_idle": 100,</span><br><span class="line">        "conn_timeout": 1000,</span><br><span class="line">        "call_timeout": 5000,</span><br><span class="line">        "numberOfReplicas": 500</span><br><span class="line">    &#125;,</span><br><span class="line">    "metric_list_file": "./api/data/metric",</span><br><span class="line">    "web_port": ":8080",  // http监听端口</span><br><span class="line">    "access_control": true, // 如果设置为false，那么任何用户都可以具备管理员权限</span><br><span class="line">    "salt": "pleaseinputwhichyouareusingnow",  //数据库加密密码的时候的salt</span><br><span class="line">    "skip_auth": false, //如果设置为true，那么访问api就不需要经过认证</span><br><span class="line">    "default_token": "default-token-used-in-server-side",  //用于服务端各模块间的访问授权</span><br><span class="line">    "gen_doc": false,</span><br><span class="line">    "gen_doc_path": "doc/module.html"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  启动api命令 <code>~/open-falcon/open-falcon start api</code></p>
<p>  停止api命令 <code>~/open-falcon/open-falcon stop api</code></p>
<p>  监控api命令 <code>~/open-falcon/open-falcon monitor api</code></p>
<p>  防火墙开放8080端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=8080/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>  部署完成api组件后，请修改dashboard组件的配置、使其能够正确寻址到api组件。请确保api组件的graph列表 与 transfer的配置 一致。</p>
</li>
<li><p>配置HBS(Heartbeat Server)</p>
<p>  心跳服务器，公司所有agent都会连到HBS，每分钟发一次心跳请求。<code>vi ~/open-falcon/hbs/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="literal">true</span>,</span><br><span class="line">    "database": "root:password@tcp(127.0.0.1:3306)/falcon_portal?loc=Local&amp;parseTime=true", # Portal的数据库地址</span><br><span class="line">    "hosts": "", # portal数据库中有个host表，如果表中数据是从其他系统同步过来的，此处配置为sync，否则就维持默认，留空即可</span><br><span class="line">    "maxIdle": 100,</span><br><span class="line">    "listen": ":6030", # hbs监听的rpc地址</span><br><span class="line">    "trustable": [""],</span><br><span class="line">    "http": &#123;</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "listen": "0.0.0.0:6031" # hbs监听的http地址</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  启动hbs命令 <code>~/open-falcon/open-falcon start hbs</code></p>
<p>  停止hbs命令 <code>~/open-falcon/open-falcon stop hbs</code></p>
<p>  监控hbs命令 <code>~/open-falcon/open-falcon monitor hbs</code></p>
<p>  防火墙开放6030、6031端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=6030/tcp --permanent</span><br><span class="line">sudo firewall-cmd --add-port=6031/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>  如果你先部署了agent，后部署的hbs，那咱们部署完hbs之后需要回去修改agent的配置，把agent配置中的heartbeat部分enabled设置为true，addr设置为hbs的rpc地址。如果hbs的配置文件维持默认，rpc端口就是6030，http端口是6031，agent中应该配置为hbs的rpc端口，小心别弄错了。</p>
</li>
<li><p>配置Judge</p>
<p>  Judge用于告警判断，agent将数据push给Transfer，Transfer不但会转发给Graph组件来绘图，还会转发给Judge用于判断是否触发告警。<code>vi ~/open-falcon/judge/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"debugHost"</span>: <span class="string">"nil"</span>,</span><br><span class="line">    <span class="attr">"remain"</span>: <span class="number">11</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:6081"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"rpc"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:6080"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"hbs"</span>: &#123;</span><br><span class="line">        "servers": ["127.0.0.1:6030"], # hbs最好放到lvs vip后面，所以此处最好配置为vip:port</span><br><span class="line">        "timeout": 300,</span><br><span class="line">        "interval": 60</span><br><span class="line">    &#125;,</span><br><span class="line">    "alarm": &#123;</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "minInterval": 300, # 连续两个报警之间至少相隔的秒数，维持默认即可</span><br><span class="line">        "queuePattern": "event:p%v",</span><br><span class="line">        "redis": &#123;</span><br><span class="line">            "dsn": "127.0.0.1:6379", # 与alarm、sender使用一个redis</span><br><span class="line">            "maxIdle": 5,</span><br><span class="line">            "connTimeout": 5000,</span><br><span class="line">            "readTimeout": 5000,</span><br><span class="line">            "writeTimeout": 5000</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  启动judge命令 <code>~/open-falcon/open-falcon start judge</code></p>
<p>  停止judge命令 <code>~/open-falcon/open-falcon stop judge</code></p>
<p>  监控judge命令 <code>~/open-falcon/open-falcon monitor judge</code></p>
<p>  防火墙开放6080、6081端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=6080/tcp --permanent</span><br><span class="line">sudo firewall-cmd --add-port=6081/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>搭建邮件服务网关</p>
<p>  使用社区提供的mail-provider</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd $GOPATH/src/github.com/open-falcon &amp;&amp; git clone https://github.com/open-falcon/mail-provider.git</span><br><span class="line"></span><br><span class="line">cd mail-provider &amp;&amp; go get ./...</span><br><span class="line"></span><br><span class="line">./control build</span><br><span class="line"></span><br><span class="line">./control pack</span><br></pre></td></tr></table></figure>
<p>  执行完上述命令之后在mail-provider目录下可找到falcon-mail-provider-0.0.1.tar.gz文件，拷贝到工作目录下</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir falcon-mail</span><br><span class="line"></span><br><span class="line">tar xf falcon-mail-provider-0.0.1.tar.gz -C falcon-mail</span><br><span class="line"></span><br><span class="line">cd falcon-mail</span><br></pre></td></tr></table></figure>
<p>  编辑cfg.json文件 <code>vi cfg.json</code></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:4000"</span>,</span><br><span class="line">        <span class="attr">"token"</span>: <span class="string">""</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"smtp"</span>: &#123;</span><br><span class="line">        <span class="attr">"addr"</span>: <span class="string">"mail.example.com:25"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"falcon@example.com"</span>,</span><br><span class="line">        <span class="attr">"password"</span>: <span class="string">"123456"</span>,</span><br><span class="line">        <span class="attr">"from"</span>: <span class="string">"falcon@example.com"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  把smtp中的addr、username、password、from替换成自己的邮件服务器相关内容</p>
<p>  启动邮件网关 <code>~/falcon-mail/control start</code><br>  停止邮件网关 <code>~/falcon-mail/control stop</code></p>
<p>  测试邮件网关 <code>curl http://$ip:4000/sender/mail -d &quot;tos=a@a.com,b@b.com&amp;subject=xx&amp;content=yy&quot;</code></p>
</li>
<li><p>配置Alarm</p>
<p>  alarm模块是处理报警event的，judge产生的报警event写入redis，alarm从redis读取处理，并进行不同渠道的发送。<code>vi ~/open-falcon/alarm/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"log_level"</span>: <span class="string">"debug"</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:9912"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"redis"</span>: &#123;</span><br><span class="line">        <span class="attr">"addr"</span>: <span class="string">"127.0.0.1:6379"</span>,</span><br><span class="line">        <span class="attr">"maxIdle"</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"highQueues"</span>: [</span><br><span class="line">            <span class="string">"event:p0"</span>,</span><br><span class="line">            <span class="string">"event:p1"</span>,</span><br><span class="line">            <span class="string">"event:p2"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"lowQueues"</span>: [</span><br><span class="line">            <span class="string">"event:p3"</span>,</span><br><span class="line">            <span class="string">"event:p4"</span>,</span><br><span class="line">            <span class="string">"event:p5"</span>,</span><br><span class="line">            <span class="string">"event:p6"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"userIMQueue"</span>: <span class="string">"/queue/user/im"</span>,</span><br><span class="line">        <span class="attr">"userSmsQueue"</span>: <span class="string">"/queue/user/sms"</span>,</span><br><span class="line">        <span class="attr">"userMailQueue"</span>: <span class="string">"/queue/user/mail"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"api"</span>: &#123;</span><br><span class="line">        "im": "http://127.0.0.1:10086/wechat",  //微信发送网关地址</span><br><span class="line">        "sms": "http://127.0.0.1:10086/sms",  //短信发送网关地址</span><br><span class="line">        "mail": "http://127.0.0.1:10086/mail", //邮件发送网关地址</span><br><span class="line">        "dashboard": "http://127.0.0.1:8081",  //dashboard模块的运行地址</span><br><span class="line">        "plus_api":"http://127.0.0.1:8080",   //falcon-plus api模块的运行地址</span><br><span class="line">        "plus_api_token": "default-token-used-in-server-side" //用于和falcon-plus api模块服务端之间的通信认证token</span><br><span class="line">    &#125;,</span><br><span class="line">    "falcon_portal": &#123;</span><br><span class="line">        "addr": "root:password@tcp(127.0.0.1:3306)/alarms?charset=utf8&amp;loc=Asia%2FChongqing",</span><br><span class="line">        "idle": 10,</span><br><span class="line">        "max": 100</span><br><span class="line">    &#125;,</span><br><span class="line">    "worker": &#123;</span><br><span class="line">        "im": 10,</span><br><span class="line">        "sms": 10,</span><br><span class="line">        "mail": 50</span><br><span class="line">    &#125;,</span><br><span class="line">    "housekeeper": &#123;</span><br><span class="line">        "event_retention_days": 7,  //报警历史信息的保留天数</span><br><span class="line">        "event_delete_batch": 100</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  启动alarm命令 <code>~/open-falcon/open-falcon start alarm</code></p>
<p>  停止alarm命令 <code>~/open-falcon/open-falcon stop alarm</code></p>
<p>  监控alarm命令 <code>~/open-falcon/open-falcon monitor alarm</code></p>
<p>  防火墙开放9912端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=9912/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置nodata</p>
<p>  nodata用于检测监控数据的上报异常。nodata和实时报警judge模块协同工作，过程为: 配置了nodata的采集项超时未上报数据，nodata生成一条默认的模拟数据；用户配置相应的报警策略，收到mock数据就产生报警。采集项上报异常检测，作为judge模块的一个必要补充，能够使judge的实时报警功能更加可靠、完善。<code>vi ~/open-falcon/nodata/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:6090"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"plus_api"</span>:&#123;</span><br><span class="line">        <span class="attr">"connectTimeout"</span>: <span class="number">500</span>,</span><br><span class="line">        <span class="attr">"requestTimeout"</span>: <span class="number">2000</span>,</span><br><span class="line">        "addr": "http://127.0.0.1:8080",  #falcon-plus api模块的运行地址</span><br><span class="line">        "token": "default-token-used-in-server-side"  #用于和falcon-plus api模块的交互认证token</span><br><span class="line">    &#125;,</span><br><span class="line">    "config": &#123;</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "dsn": "root:@tcp(127.0.0.1:3306)/falcon_portal?loc=Local&amp;parseTime=true&amp;wait_timeout=604800",</span><br><span class="line">        "maxIdle": 4</span><br><span class="line">    &#125;,</span><br><span class="line">    "collector":&#123;</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "batch": 200,</span><br><span class="line">        "concurrent": 10</span><br><span class="line">    &#125;,</span><br><span class="line">    "sender":&#123;</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "connectTimeout": 500,</span><br><span class="line">        "requestTimeout": 2000,</span><br><span class="line">        "transferAddr": "127.0.0.1:6060",  #transfer的http监听地址,一般形如"domain.transfer.service:6060"</span><br><span class="line">        "batch": 500</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  启动nodata命令 <code>~/open-falcon/open-falcon start nodata</code></p>
<p>  停止nodata命令 <code>~/open-falcon/open-falcon stop nodata</code></p>
<p>  监控nodata命令 <code>~/open-falcon/open-falcon monitor nodata</code></p>
<p>  防火墙开放6090端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=6090/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Aggregator</p>
<p>  集群聚合模块。聚合某集群下的所有机器的某个指标的值，提供一种集群视角的监控体验。<code>vi ~/open-falcon/aggregator/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:6055"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"database"</span>: &#123;</span><br><span class="line">        <span class="attr">"addr"</span>: <span class="string">"root:@tcp(127.0.0.1:3306)/falcon_portal?loc=Local&amp;parseTime=true"</span>,</span><br><span class="line">        <span class="attr">"idle"</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">"ids"</span>: [<span class="number">1</span>, <span class="number">-1</span>],</span><br><span class="line">        <span class="attr">"interval"</span>: <span class="number">55</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"api"</span>: &#123;</span><br><span class="line">        <span class="attr">"connect_timeout"</span>: <span class="number">500</span>,</span><br><span class="line">        <span class="attr">"request_timeout"</span>: <span class="number">2000</span>,</span><br><span class="line">        "plus_api": "http://127.0.0.1:8080",  #falcon-plus api模块的运行地址</span><br><span class="line">        "plus_api_token": "default-token-used-in-server-side", #和falcon-plus api 模块交互的认证token</span><br><span class="line">        "push_api": "http://127.0.0.1:1988/v1/push"  #push数据的http接口，这是agent提供的接口</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  启动aggregator命令 <code>~/open-falcon/open-falcon start aggregator</code></p>
<p>  停止aggregator命令 <code>~/open-falcon/open-falcon stop aggregator</code></p>
<p>  监控aggregator命令 <code>~/open-falcon/open-falcon monitor aggregator</code></p>
<p>  防火墙开放6055端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=6055/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Gateway</p>
<p>  如果您没有遇到机房分区问题，请直接忽略此组件。如果您已经遇到机房分区问题、并急需解决机房分区时监控数据回传的问题，请使用该组件。多IDC时，可能面对 “分区到中心的专线网络质量较差&amp;公网ACL不通” 等问题。这时，可以在分区内部署一套数据路由服务，接收本分区内的所有流量(包括所有的agent流量)，然后通过公网(开通ACL)，将数据push给中心的Transfer。<code>vi ~/open-falcon/gateway/config/cfg.json</code></p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:6060"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"rpc"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:8433"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"socket"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"listen"</span>: <span class="string">"0.0.0.0:4444"</span>,</span><br><span class="line">        <span class="attr">"timeout"</span>: <span class="number">3600</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"transfer"</span>: &#123;</span><br><span class="line">        "enabled": true, //true/false, 表示是否开启向tranfser转发数据</span><br><span class="line">        "batch": 200, //数据转发的批量大小，可以加快发送速度，建议保持默认值</span><br><span class="line">        "retry": 2, //重试次数，默认1、不重试</span><br><span class="line">        "connTimeout": 1000, //毫秒，与后端建立连接的超时时间，可以根据网络质量微调，建议保持默认</span><br><span class="line">        "callTimeout": 5000, //毫秒，发送数据给后端的超时时间，可以根据网络质量微调，建议保持默认</span><br><span class="line">        "maxConns": 32, //连接池相关配置，最大连接数，建议保持默认</span><br><span class="line">        "maxIdle": 32, //连接池相关配置，最大空闲连接数，建议保持默认</span><br><span class="line">        "cluster": &#123; //transfer服务器集群，支持多条记录</span><br><span class="line">            "t1": "127.0.0.1:8433" //一个transfer实例，形如"node":"$hostname:$port"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装配置dashboard</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd ~ &amp;&amp; git clone https://github.com/open-falcon/dashboard.git</span><br><span class="line">sudo yum install -y python-virtualenv</span><br><span class="line">sudo yum install -y python-devel</span><br><span class="line">sudo yum install -y openldap-devel</span><br><span class="line">sudo yum install -y mysql-devel</span><br><span class="line">sudo yum groupinstall "Development tools"</span><br><span class="line">cd ~/dashboard</span><br><span class="line">virtualenv ./env</span><br><span class="line">sudo ./env/bin/pip install -r pip_requirements.txt</span><br></pre></td></tr></table></figure>
<p>  编辑<code>~/dashboard/rrd/config.py</code> 文件</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Falcon+ API 访问路径</span></span><br><span class="line">API_ADDR = os.environ.get(<span class="string">"API_ADDR"</span>,<span class="string">"http://127.0.0.1:8080/api/v1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># portal database portal 数据库</span></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> read from api instead of db</span></span><br><span class="line">PORTAL_DB_HOST = os.environ.get(<span class="string">"PORTAL_DB_HOST"</span>,<span class="string">"127.0.0.1"</span>)</span><br><span class="line">PORTAL_DB_PORT = int(os.environ.get(<span class="string">"PORTAL_DB_PORT"</span>,<span class="number">3306</span>))</span><br><span class="line">PORTAL_DB_USER = os.environ.get(<span class="string">"PORTAL_DB_USER"</span>,<span class="string">"root"</span>)</span><br><span class="line">PORTAL_DB_PASS = os.environ.get(<span class="string">"PORTAL_DB_PASS"</span>,<span class="string">""</span>)</span><br><span class="line">PORTAL_DB_NAME = os.environ.get(<span class="string">"PORTAL_DB_NAME"</span>,<span class="string">"falcon_portal"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># alarm database 告警数据库</span></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> read from api instead of db</span></span><br><span class="line">ALARM_DB_HOST = os.environ.get(<span class="string">"ALARM_DB_HOST"</span>,<span class="string">"127.0.0.1"</span>)</span><br><span class="line">ALARM_DB_PORT = int(os.environ.get(<span class="string">"ALARM_DB_PORT"</span>,<span class="number">3306</span>))</span><br><span class="line">ALARM_DB_USER = os.environ.get(<span class="string">"ALARM_DB_USER"</span>,<span class="string">"root"</span>)</span><br><span class="line">ALARM_DB_PASS = os.environ.get(<span class="string">"ALARM_DB_PASS"</span>,<span class="string">""</span>)</span><br><span class="line">ALARM_DB_NAME = os.environ.get(<span class="string">"ALARM_DB_NAME"</span>,<span class="string">"alarms"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ldap config 域控管理，如果不需集成域控，此处可以忽略</span></span><br><span class="line">LDAP_ENABLED = os.environ.get(<span class="string">"LDAP_ENABLED"</span>,<span class="keyword">False</span>)</span><br><span class="line">LDAP_SERVER = os.environ.get(<span class="string">"LDAP_SERVER"</span>,<span class="string">"ldap.forumsys.com:389"</span>)</span><br><span class="line">LDAP_BASE_DN = os.environ.get(<span class="string">"LDAP_BASE_DN"</span>,<span class="string">"dc=example,dc=com"</span>)</span><br><span class="line">LDAP_BINDDN_FMT = os.environ.get(<span class="string">"LDAP_BINDDN_FMT"</span>,<span class="string">"uid=%s,dc=example,dc=com"</span>)</span><br><span class="line">LDAP_SEARCH_FMT = os.environ.get(<span class="string">"LDAP_SEARCH_FMT"</span>,<span class="string">"uid=%s"</span>)</span><br><span class="line">LDAP_ATTRS = [<span class="string">"cn"</span>,<span class="string">"mail"</span>,<span class="string">"telephoneNumber"</span>]</span><br><span class="line">LDAP_TLS_START_TLS = <span class="keyword">False</span></span><br><span class="line">LDAP_TLS_CACERTDIR = <span class="string">""</span></span><br><span class="line">LDAP_TLS_CACERTFILE = <span class="string">"/etc/openldap/certs/ca.crt"</span></span><br><span class="line">LDAP_TLS_CERTFILE = <span class="string">""</span></span><br><span class="line">LDAP_TLS_KEYFILE = <span class="string">""</span></span><br><span class="line">LDAP_TLS_REQUIRE_CERT = <span class="keyword">True</span></span><br><span class="line">LDAP_TLS_CIPHER_SUITE = <span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>  启动dashboard <code>~/dashboard/control start</code></p>
<p>  停止dashboard运行 <code>~/dashboard/control stop</code></p>
<p>   防火墙开放8081端口</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=8081/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2017/11/25/CentOS7多网卡配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/25/CentOS7多网卡配置/" itemprop="url">CentOS7 多网卡配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-25T11:00:40+08:00">
                2017-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/11/25/CentOS7多网卡配置/" class="leancloud_visitors" data-flag-title="CentOS7 多网卡配置">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="编辑并启用网卡ens160-vi-etc-sysconfig-network-scripts-ifcfg-ens160"><a href="#编辑并启用网卡ens160-vi-etc-sysconfig-network-scripts-ifcfg-ens160" class="headerlink" title="编辑并启用网卡ens160  vi  /etc/sysconfig/network-scripts/ifcfg-ens160"></a>编辑并启用网卡ens160  <code>vi  /etc/sysconfig/network-scripts/ifcfg-ens160</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line"># 使用静态IP，如果想要自动分配，改为dhcp</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line"># 当前网卡名称</span><br><span class="line">NAME=ens160</span><br><span class="line">UUID=b36e2765-67c6-477f-abcc-43d7ab6935cf</span><br><span class="line"># 设备名称，改为当前编辑的网卡名称</span><br><span class="line">DEVICE=ens160</span><br><span class="line"># yes为启用网卡，no 为禁用</span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">#当BOOTPROTO=static或者none使用 开始</span><br><span class="line">#ip地址</span><br><span class="line">IPADDR=10.3.175.21</span><br><span class="line"></span><br><span class="line">PREFIX=22</span><br><span class="line"></span><br><span class="line">#网关</span><br><span class="line">GATEWAY=10.3.175.253</span><br><span class="line"></span><br><span class="line">#子网掩码</span><br><span class="line">NETMASK=255.255.252.0</span><br><span class="line"></span><br><span class="line">#DNS</span><br><span class="line">DNS1=10.3.175.253</span><br><span class="line">#当BOOTPROTO=static或者none使用 结束</span><br><span class="line"></span><br><span class="line">IPV6_PEERDNS=yes</span><br><span class="line">IPV6_PEERROUTES=yes</span><br><span class="line">IPV6_PRIVACY=no</span><br><span class="line">ZONE=public</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<h2 id="编辑并启用网卡ens192-vi-etc-sysconfig-network-scripts-ifcfg-ens192"><a href="#编辑并启用网卡ens192-vi-etc-sysconfig-network-scripts-ifcfg-ens192" class="headerlink" title="编辑并启用网卡ens192  vi /etc/sysconfig/network-scripts/ifcfg-ens192"></a>编辑并启用网卡ens192  <code>vi /etc/sysconfig/network-scripts/ifcfg-ens192</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens192</span><br><span class="line">UUID=d4df7f6a-17a8-425c-ac37-3359eb4f2eef</span><br><span class="line">DEVICE=ens192</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=172.16.11.21</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">ZONE=public</span><br></pre></td></tr></table></figure>
<h2 id="添加静态路由-vi-etc-sysconfig-network-scripts-route-ens192"><a href="#添加静态路由-vi-etc-sysconfig-network-scripts-route-ens192" class="headerlink" title="添加静态路由  vi /etc/sysconfig/network-scripts/route-ens192"></a>添加静态路由  <code>vi /etc/sysconfig/network-scripts/route-ens192</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">172.16.20.0/24 via 172.16.11.1 dev ens192</span><br><span class="line">172.16.10.0/24 via 172.16.11.1 dev ens192</span><br></pre></td></tr></table></figure>
<h2 id="重启网络服务-service-network-restart"><a href="#重启网络服务-service-network-restart" class="headerlink" title="重启网络服务 service network restart"></a>重启网络服务 <code>service network restart</code></h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2017/11/15/CentOS7-LNMP-Zabbix3.4 环境搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/15/CentOS7-LNMP-Zabbix3.4 环境搭建/" itemprop="url">CentOS7 LNMP Zabbix3.4 环境搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-15T11:00:40+08:00">
                2017-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Zabbix/" itemprop="url" rel="index">
                    <span itemprop="name">Zabbix</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/11/15/CentOS7-LNMP-Zabbix3.4 环境搭建/" class="leancloud_visitors" data-flag-title="CentOS7 LNMP Zabbix3.4 环境搭建">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><ul>
<li>系统版本：CentOS 7</li>
<li>Nginx版本:1.12.2</li>
<li>Php版本：7.1.11</li>
<li>Mysql版本：5.6</li>
</ul>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li>关闭selinux，开启selinux会引起一连串问题，甚至zabbix的discovery功能也不能正常使用</li>
</ul>
<p><code>sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</code></p>
<p> 确认是否修改成功</p>
<p> <code>grep SELINUX /etc/selinux/config</code></p>
<p>然后重启系统即可 </p>
<h2 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h2><ul>
<li>下载nginx <code>wget http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.12.2-1.el7_4.ngx.x86_64.rpm</code></li>
<li>安装 nginx <code>rpm -ivh  nginx-1.12.2-1.el7_4.ngx.x86_64.rpm</code></li>
<li>设置nginx开机自启动  <code>systemctl enable nginx</code></li>
<li>启动nginx   <code>systemctl start nginx</code></li>
<li>查看nginx 启动状态  <code>systemctl status nginx</code></li>
<li>不关闭nginx，修改配置文件生效方法 <code>nginx -s reload</code></li>
<li>防火墙开放80端口  <code>firewall-cmd   --add-port=80/tcp   --permanent</code></li>
<li>重新加载防火墙配置 <code>firewall-cmd --reload</code></li>
<li>查看防火墙当前开放的端口 <code>firewall-cmd --list-ports</code></li>
</ul>
<h2 id="安装Mysql"><a href="#安装Mysql" class="headerlink" title="安装Mysql"></a>安装Mysql</h2><ul>
<li>Centos7自带的mysql是mariadb ,我们可以通过如下命令查看 <code>yum search mysql|tac</code></li>
<li>开始安装mariadb <code>yum -y install mariadb mariadb-server</code></li>
<li>设置开机自启动mysql  <code>systemctl enable mariadb.service</code></li>
<li>启动mysql <code>systemctl start mariadb.service</code></li>
<li>初始化mysql数据库，并配置root用户密码 <code>mysql_secure_installation</code></li>
</ul>
<h2 id="安装PHP"><a href="#安装PHP" class="headerlink" title="安装PHP"></a>安装PHP</h2><ul>
<li>下载php7 <code>wget http://cn2.php.net/distributions/php-7.1.11.tar.gz</code></li>
<li>解压并进入php目录 <code>tar zxvf php-7.1.11.tar.gz &amp;&amp; cd ./php-7.1.11</code></li>
<li>安装扩展包更新包    <code>yum  install epel-release</code></li>
<li>安装php依赖包 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel </span><br><span class="line"></span><br><span class="line">yum install -y libmcrypt libmcrypt-devel gcc</span><br></pre></td></tr></table></figure>
<ul>
<li>编译配置php</li>
</ul>
<p><code>./configure --prefix=/usr/local/php --with-config-file-path=/etc --enable-fpm --with-fpm-user=nginx  --with-fpm-group=nginx --enable-inline-optimization --disable-debug --disable-rpath --enable-shared  --enable-soap --with-libxml-dir --with-xmlrpc --with-openssl --with-mcrypt --with-mhash --with-pcre-regex --with-sqlite3 --with-zlib --enable-bcmath  --with-iconv --with-bz2 --enable-calendar --with-curl --with-cdb --enable-dom --enable-exif --enable-fileinfo --enable-filter --with-pcre-dir --enable-ftp --with-gd --with-openssl-dir  --with-jpeg-dir --with-png-dir --with-zlib-dir --with-freetype-dir --enable-gd-native-ttf --enable-gd-jis-conv --with-gettext --with-gmp --with-mhash --enable-json --enable-mbstring --enable-mbregex --enable-mbregex-backtrack --with-libmbfl --with-onig --enable-pdo --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-zlib-dir --with-pdo-sqlite --with-readline --enable-session --enable-shmop --enable-simplexml --enable-sockets  --enable-sysvmsg --enable-sysvsem --enable-sysvshm --enable-wddx --with-libxml-dir --with-xsl --enable-zip --enable-mysqlnd-compression-support --with-pear --enable-opcache</code></p>
<ul>
<li>编译与安装,需要一段时间慢慢等候  <code>make &amp;&amp; make install</code></li>
<li>添加 PHP 命令到环境变量 <code>vi /etc/profile</code>,在末尾加入 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PATH=$PATH:/usr/local/php/bin</span><br><span class="line"></span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure>
<ul>
<li>要使改动立即生效执行 <code>source /etc/profile</code></li>
<li>查看环境变量 <code>echo $PATH</code></li>
<li>查看php版本 <code>php -v</code></li>
<li>配置php-fpm </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp ./php.ini-production /etc/php.ini  #从php源代码中拷贝php.ini-production 到并命名为 /etc/php.ini</span><br><span class="line">cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf</span><br><span class="line">cp /usr/local/php/etc/php-fpm.d/www.conf.default /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span><br><span class="line">chmod +x /etc/init.d/php-fpm</span><br></pre></td></tr></table></figure>
<ul>
<li>修改/etc/php.ini 文件 <code>vi /etc/php.ini</code>,找到配置项，并修改成如下内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">max_execution_time = 300</span><br><span class="line">max_input_time = 300</span><br><span class="line">memory_limit = 128M</span><br><span class="line">post_max_size = 16M</span><br><span class="line">date.timezone = Asia/Shanghai</span><br></pre></td></tr></table></figure>
<ul>
<li><p>启动php-fpm <code>/etc/init.d/php-fpm start</code></p>
</li>
<li><p>配置nginx,绑定服务器 <code>vi /etc/nginx/conf.d/default.conf</code></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name  127.0.0.1;</span><br><span class="line">	root /data/www;  # 该项要修改为你准备存放相关网页的路径</span><br><span class="line">	location / &#123;</span><br><span class="line">		index  index.php index.html index.htm;</span><br><span class="line">		#如果请求既不是一个文件，也不是一个目录，则执行一下重写规则</span><br><span class="line">		if (!-e $request_filename)</span><br><span class="line">		&#123;</span><br><span class="line">			#地址作为将参数rewrite到index.php上。</span><br><span class="line">			rewrite ^/(.*)$ /index.php/$1;</span><br><span class="line">			#若是子目录则使用下面这句，将subdir改成目录名称即可。</span><br><span class="line">			#rewrite ^/subdir/(.*)$ /subdir/index.php/$1;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	#proxy the php scripts to php-fpm</span><br><span class="line">	location ~ \.php &#123;</span><br><span class="line">		include fastcgi_params;</span><br><span class="line">		##pathinfo支持start</span><br><span class="line">		#定义变量 $path_info ，用于存放pathinfo信息</span><br><span class="line">		set $path_info &quot;&quot;;</span><br><span class="line">		#定义变量 $real_script_name，用于存放真实地址</span><br><span class="line">		set $real_script_name $fastcgi_script_name;</span><br><span class="line">		#如果地址与引号内的正则表达式匹配</span><br><span class="line">		if ($fastcgi_script_name ~ &quot;^(.+?\.php)(/.+)$&quot;) &#123;</span><br><span class="line">			#将文件地址赋值给变量 $real_script_name</span><br><span class="line">			set $real_script_name $1;</span><br><span class="line">			#将文件地址后的参数赋值给变量 $path_info</span><br><span class="line">			set $path_info $2;</span><br><span class="line">		&#125;</span><br><span class="line">		#配置fastcgi的一些参数</span><br><span class="line">		fastcgi_param SCRIPT_FILENAME $document_root$real_script_name;</span><br><span class="line">		fastcgi_param SCRIPT_NAME $real_script_name;</span><br><span class="line">		fastcgi_param PATH_INFO $path_info;</span><br><span class="line">		###pathinfo支持end</span><br><span class="line">	    fastcgi_intercept_errors on;</span><br><span class="line">		fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">    location ^~ /data/runtime &#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    location ^~ /application &#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location ^~ /simplewind &#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>重启nginx <code>nginx -s reload</code></li>
<li>创建测试php文件 <code>vi /data/www/info.php</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">     phpinfo();</span><br></pre></td></tr></table></figure>
<ul>
<li>访问 <a href="http://127.0.0.1/info.php" target="_blank" rel="noopener">http://127.0.0.1/info.php</a> </li>
</ul>
<h2 id="安装zabbix-server"><a href="#安装zabbix-server" class="headerlink" title="安装zabbix-server"></a>安装zabbix-server</h2><ul>
<li>下载安装zabbix的YUM源 <code>rpm -ivh http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm</code></li>
<li>安装zabbix <code>yum -y install zabbix-server-mysql zabbix-agent</code></li>
<li>在mysql中创建zbbix帐号</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create database zabbix character set utf8 collate utf8_bin;</span><br><span class="line">grant all privileges on zabbix.* to &apos;zabbix&apos;@&apos;%&apos; identified by &apos;zabbixpass&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
<ul>
<li>导入zabbix表结构和初始化到数据库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/doc/zabbix-server-mysql-3.41/</span><br><span class="line">zcat create.sql.gz | mysql -u root -p zabbix</span><br></pre></td></tr></table></figure>
<ul>
<li>配置Zabbix服务器端 <code>vi /etc/zabbix/zabbix_server.conf</code>,找到配置项，并更改配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DBHost=localhost</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbixpass</span><br></pre></td></tr></table></figure>
<ul>
<li>切换文件夹所有人</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R zabbix:zabbix /etc/zabbix</span><br><span class="line">chown -R zabbix:zabbix /usr/lib/zabbix</span><br></pre></td></tr></table></figure>
<ul>
<li>设置开机启动zabbixserver <code>systemctl enable zabbix-server</code></li>
<li>启动zabbix server <code>systemctl start zabbix-server</code></li>
<li>防火墙开放10051端口，zabbix agent会用到这个端口  <code>firewall-cmd   --add-port=10051/tcp   --permanent</code></li>
<li>重新加载防火墙配置 <code>firewall-cmd --reload</code></li>
<li>查看防火墙当前开放的端口 <code>firewall-cmd --list-ports</code></li>
</ul>
<h2 id="安装zabbix-web"><a href="#安装zabbix-web" class="headerlink" title="安装zabbix-web"></a>安装zabbix-web</h2><ul>
<li>下载 zabbix源代码 <code>wget -O zabbix-3.4.4.tar.gz  http://sourceforge.net/projects/zabbix/files/ZABBIX%20Latest%20Stable/3.4.4/zabbix-3.4.4.tar.gz/download</code></li>
<li>解压并进入zabbix目录 <code>tar zxvf zabbix-3.4.4.tar.gz</code></li>
<li>拷贝<code>zabbix-3.4.4/frontends/php</code> 文件夹中所有内容到 <code>/data/www/zabbix</code>文件夹中  <code>cp -rf ./zabbix-3.4.4/frontends/php/ /data/www/zabbix</code></li>
<li>新建配置文件 <code>mv /data/www/zabbix/conf/zabbix.conf.php.example /data/www/zabbix/conf/zabbix.conf.php</code> </li>
<li>修改配置文件 <code>vi /data/www/zabbix/conf/zabbix.conf.php</code>,修改其中数据ip地址，数据库名，用户名密码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// Zabbix GUI configuration file.</span><br><span class="line">global $DB;</span><br><span class="line"></span><br><span class="line">$DB[&apos;TYPE&apos;]				= &apos;MYSQL&apos;;</span><br><span class="line">$DB[&apos;SERVER&apos;]			= &apos;localhost&apos;;</span><br><span class="line">$DB[&apos;PORT&apos;]				= &apos;0&apos;;</span><br><span class="line">$DB[&apos;DATABASE&apos;]			= &apos;zabbix&apos;;</span><br><span class="line">$DB[&apos;USER&apos;]				= &apos;zabbix&apos;;</span><br><span class="line">$DB[&apos;PASSWORD&apos;]			= &apos;zabbixpass&apos;;</span><br><span class="line">// Schema name. Used for IBM DB2 and PostgreSQL.</span><br><span class="line">$DB[&apos;SCHEMA&apos;]			= &apos;&apos;;</span><br><span class="line"></span><br><span class="line">$ZBX_SERVER				= &apos;localhost&apos;;</span><br><span class="line">$ZBX_SERVER_PORT		= &apos;10051&apos;;</span><br><span class="line">$ZBX_SERVER_NAME		= &apos;zabbix server&apos;;</span><br><span class="line"></span><br><span class="line">$IMAGE_FORMAT_DEFAULT	= IMAGE_FORMAT_PNG;</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line">- 进入zabbix web配置，访问 http://127.0.0.1/zabbix</span><br><span class="line"></span><br><span class="line">## 配置 zabbix-agent</span><br><span class="line"></span><br><span class="line">- 编辑zabbix-agent配置文件 `vi /etc/zabbix/zabbix_agentd.conf`,找到如下配置</span><br></pre></td></tr></table></figure>
<p>Server=127.0.0.1<br>ServerActive=127.0.0.1<br>Hostname=Zabbix server<br>```<br>其中Server、ServerActive 填的是zabbix-server所在服务器ip地址，Hostname填写的zabbix-agent的名称，唯一不可重复，配置主机监控时填写的主机名称必须和Hostname一致</p>
<ul>
<li>设置开机启动zabbixserver <code>systemctl enable zabbix-agent</code></li>
<li>启动zabbix server <code>systemctl start zabbix-agent</code></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2017/10/28/mongodb-replica-set (mongodb主从仲裁节点配置)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/28/mongodb-replica-set (mongodb主从仲裁节点配置)/" itemprop="url">mongodb-replica-set (mongodb主从仲裁节点配置)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-28T11:00:40+08:00">
                2017-10-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mongodb/" itemprop="url" rel="index">
                    <span itemprop="name">mongodb</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/10/28/mongodb-replica-set (mongodb主从仲裁节点配置)/" class="leancloud_visitors" data-flag-title="mongodb-replica-set (mongodb主从仲裁节点配置)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><ul>
<li>系统：CentOS 6.9</li>
<li><p>MongoDB版本：<a href="https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel62-3.4.10.tgz" target="_blank" rel="noopener">mongodb-linux-x86_64-rhel62-3.4.10</a></p>
</li>
<li><p>设备3台：172.16.10.42(27020端口)，172.16.10.90(27020端口)，172.16.10.199(27020端口)，如果没有足够设备也可部署同一台设备上面，只需要修改端口即可。</p>
</li>
</ul>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li><p>同步系统时间：保证各个机器的时间一致，可使用/usr/sbin/ntpdate time.nist.gov 进行系统时间同步，在系统任务中添加新的任务 crontab -e<br><code>0 12 * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1</code></p>
</li>
<li><p>配置同时允许打开的文件最大数<br>查看系统允许同时打开文件的最大数 :<code>ulimit -a</code><br>查看系统允许的最大句柄文件数:<code>cat /proc/sys/fs/file-max</code><br>修改允许最大打开文件数，修改之后会永久生效，在【/etc/security/limits.conf】中，增加下面的代码：<br><code>*               soft    nofile            65536</code><br><code>*               hard    nofile            65536</code></p>
</li>
<li><p>保证3台设备相互之间网络访问可达</p>
</li>
<li>防火墙打开27020端口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/sbin/iptables -I INPUT -p tcp --dport 27020 -j ACCEPT      #开放端口</span><br><span class="line">/etc/init.d/iptables save   # 保存修改</span><br><span class="line"> service iptables restart   # 重启防火墙，修改生效</span><br></pre></td></tr></table></figure>
<h2 id="准备安装"><a href="#准备安装" class="headerlink" title="准备安装"></a>准备安装</h2><ul>
<li>选择MongoDB存放位置，例如: /home/mongodb</li>
<li>使用cd 命令<code>cd /home/mongodb</code> 进入mongodb 目录，下载MongoDB 压缩包 <code>curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel62-3.4.10.tgz</code></li>
<li>解压文件 <code>tar -xzvf mongodb-linux-x86_64-rhel62-3.4.10.tgz</code> 到当前目录下</li>
<li>创建数据存放文件夹 <code>mkdir data</code>,创建日志存放文件夹 <code>mkdir log</code></li>
<li>分配机器172.16.10.42（主节点），172.16.10.90（从节点），172.16.10.199（arb仲裁节点）</li>
</ul>
<h2 id="安装MongoDB主节点"><a href="#安装MongoDB主节点" class="headerlink" title="安装MongoDB主节点"></a>安装MongoDB主节点</h2><ul>
<li>在mongdb 目录下新建mongod.conf文件，编辑如下内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">	destination: file</span><br><span class="line">	path: /home/mongodb/log/mongod.log      #日志存放位置</span><br><span class="line">	logAppend: true                                             #以追加的形式写入日志</span><br><span class="line">storage:</span><br><span class="line">	dbPath: /home/mongodb/data                            #数据存放地址</span><br><span class="line">	journal:</span><br><span class="line">		enabled: true</span><br><span class="line">	directoryPerDB: true                                       #每个数据库单独一个目录</span><br><span class="line">processManagement:</span><br><span class="line">	fork: true</span><br><span class="line">	pidFilePath: /home/mongodb/mongod.pid  #进程文件存放位置</span><br><span class="line">net:</span><br><span class="line">	port: 27020                                                     #mongo 占用的端口号</span><br><span class="line">setParameter:</span><br><span class="line">	failIndexKeyTooLong: false</span><br></pre></td></tr></table></figure>
<ul>
<li><p>启动mongdb服务 <code>/home/mongodb/mongodb-linux-x86_64-rhel62-3.4.10/bin/mongod --config /home/mongodb/mongod.conf</code></p>
</li>
<li><p>控制台连接mongo <code>/home/mongodb/mongodb-linux-x86_64-rhel62-3.4.10/bin/mongo 127.0.0.1:27020</code> ,必须指定端口号，因为默认的端口为27017</p>
</li>
<li><p>创建管理员帐号</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">use  admin;  #进入admin数据库,系统自带</span><br><span class="line">db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: &quot;admin&quot;,</span><br><span class="line">     pwd: &quot;admin&quot;,</span><br><span class="line">     roles: [ &quot;__system&quot;,&quot;backup&quot;,&quot;clusterAdmin&quot;,&quot;dbAdminAnyDatabase&quot;,&quot;readWriteAnyDatabase&quot;,&quot;userAdminAnyDatabase&quot; ]</span><br><span class="line">   &#125;</span><br><span class="line">);  #创建用户，并分配用户角色</span><br></pre></td></tr></table></figure>
<ul>
<li>查询上一步操作创建的用户 <code>db.system.users.find({&quot;user&quot;:&quot;admin&quot;})</code><br>查询结果如下：</li>
</ul>
<ul>
<li><p>关闭mongodb 服务  <code>/home/mongodb/mongodb-linux-x86_64-rhel62-3.4.10/bin/mongod --config /home/mongodb/mongod.conf  --shutdown</code></p>
</li>
<li><p>生成keyfile文件 <code>openssl rand -base64 741 &gt; /home/mongodb/mongodb.keyfile</code></p>
</li>
<li><p>修改主节点mongd.conf文件为如下内容</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">   destination: file</span><br><span class="line">   path: /home/mongodb/log/mongod.log</span><br><span class="line">   logAppend: true</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /home/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">  directoryPerDB: true</span><br><span class="line">processManagement:</span><br><span class="line">   fork: true</span><br><span class="line">   pidFilePath: /home/mongodb/mongod.pid</span><br><span class="line">net:</span><br><span class="line">   port: 27020</span><br><span class="line">setParameter:</span><br><span class="line">  failIndexKeyTooLong: false</span><br><span class="line">security:</span><br><span class="line">  keyFile: /home/mongodb/mongodb.keyfile       # 使用keyfile认证</span><br><span class="line">  authorization: enabled</span><br><span class="line">replication:</span><br><span class="line">  replSetName: mongodb_set   #名称可以自定义，但是必须保证主节点、从节点、仲裁节点统一</span><br></pre></td></tr></table></figure>
<h2 id="安装MongoDB从节点、仲裁节点"><a href="#安装MongoDB从节点、仲裁节点" class="headerlink" title="安装MongoDB从节点、仲裁节点"></a>安装MongoDB从节点、仲裁节点</h2><ul>
<li><p>同理在172.16.10.90，172.16.10.199 <code>/home/mongodb</code> 目录下新建 data、log目录</p>
</li>
<li><p>拷贝主节点 (172.16.10.42) <code>/home/mongodb</code> 目录下的 <code>mongodb.keyfile</code>、<code>mongod.conf</code>文件以及 <code>mongodb-linux-x86_64-rhel62-3.4.10</code> 文件夹 到从节点已经仲裁节点的<code>/home/mongodb</code> 目录下</p>
</li>
<li><p>修改仲裁节点` mongod.conf`` 文件内容如下</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">   destination: file</span><br><span class="line">   path: /home/mongodb/log/mongod.log</span><br><span class="line">   logAppend: true</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /home/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: false                                         # 仲裁节点本地不保存数据</span><br><span class="line">  directoryPerDB: true</span><br><span class="line">processManagement:</span><br><span class="line">   fork: true</span><br><span class="line">   pidFilePath: /home/mongodb/mongod.pid</span><br><span class="line">net:</span><br><span class="line">   port: 27020</span><br><span class="line">setParameter:</span><br><span class="line">  failIndexKeyTooLong: false</span><br><span class="line">security:</span><br><span class="line">  keyFile: /home/mongodb/mongodb.keyfile       # 使用keyfile认证</span><br><span class="line">  authorization: enabled</span><br><span class="line">replication:</span><br><span class="line">  replSetName: mongodb_set   #名称可以自定义，但是必须保证主节点、从节点、仲裁节点统一</span><br></pre></td></tr></table></figure>
<h2 id="配置主节点、从节点、仲裁节点"><a href="#配置主节点、从节点、仲裁节点" class="headerlink" title="配置主节点、从节点、仲裁节点"></a>配置主节点、从节点、仲裁节点</h2><ul>
<li><p>分别在三台设备上执行 <code>/home/mongodb/mongodb-linux-x86_64-rhel62-3.4.10/bin/mongod --config /home/mongodb/mongod.conf</code> 启动mongodb服务</p>
</li>
<li><p>控制台连接主节点(172.16.10.42)mongo <code>/home/mongodb/mongodb-linux-x86_64-rhel62-3.4.10/bin/mongo 127.0.0.1:27020 -u admin -p</code> , 使用admin帐号密码登录mongodb</p>
</li>
<li>初始化副本集配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use admin;</span><br><span class="line">config=&#123;_id:&quot;mongodb_set&quot;,members:[&#123;_id:0,host:&quot;172.16.10.42&quot;,&quot;priority&quot;:20&#125;]&#125;</span><br><span class="line">rs.initiate(config);</span><br></pre></td></tr></table></figure>
<p>确认返回的是{ “ok” : 1 }<br>上面config里面，是当前主节点对外的ip，即从节点以及仲裁节点能够访问到的ip<br>查看集群节点的状态:<code>rs.status();</code></p>
<ul>
<li>添加仲裁节点</li>
</ul>
<p><code>rs.addArb(&quot;172.16.10.199:27020&quot;);</code></p>
<ul>
<li>添加从节点</li>
</ul>
<p><code>rs.add(&quot;172.16.10.90:27020&quot;);</code></p>
<ul>
<li>查看集群配置<code>rs.config();</code><br>显示结果如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">mongodb_set:PRIMARY&gt; rs.config()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : &quot;mongodb_set&quot;,</span><br><span class="line">        &quot;version&quot; : 4,</span><br><span class="line">        &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">        &quot;members&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 0,</span><br><span class="line">                        &quot;host&quot; : &quot;172.16.10.42:27020&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : false,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 20,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 1,</span><br><span class="line">                        &quot;host&quot; : &quot;172.16.10.199:27020&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : true,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 1,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 2,</span><br><span class="line">                        &quot;host&quot; : &quot;172.16.10.90:27020&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : false,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 1,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;settings&quot; : &#123;</span><br><span class="line">                &quot;chainingAllowed&quot; : true,</span><br><span class="line">                &quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">                &quot;heartbeatTimeoutSecs&quot; : 10,</span><br><span class="line">                &quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">                &quot;catchUpTimeoutMillis&quot; : 60000,</span><br><span class="line">                &quot;getLastErrorModes&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;getLastErrorDefaults&quot; : &#123;</span><br><span class="line">                        &quot;w&quot; : 1,</span><br><span class="line">                        &quot;wtimeout&quot; : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;replicaSetId&quot; : ObjectId(&quot;59f82d3d21b782e865dc270a&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改从节点为只读节点<br>获取当前配置，修改之后重新写入配置 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfg = rs.conf();</span><br><span class="line">cfg.members[2].priority=0</span><br><span class="line">rs.reconfig(cfg);</span><br></pre></td></tr></table></figure>
<ul>
<li>修改从节点为永远不可能被选为主节点（非必须）<br>获取当前配置，修改之后重新写入配置 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfg = rs.conf();</span><br><span class="line">cfg.members[2].votes=0</span><br><span class="line">rs.reconfig(cfg);</span><br></pre></td></tr></table></figure>
<p>所有配置到此结束</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://aiguanglee.github.io/2016/03/28/redis安装配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Riky Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="工作杂记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/28/redis安装配置/" itemprop="url">linux下Redis 的安装配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-28T11:00:40+08:00">
                2016-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/03/28/redis安装配置/" class="leancloud_visitors" data-flag-title="linux下Redis 的安装配置">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>linux系统下下载并安装</p>
<p>下载redis安装包</p>
<p><code>wget http://download.redis.io/releases/redis-3.0.3.tar.gz</code></p>
<p>解压redis安装包</p>
<p><code>tar zxvf redis-3.0.3.tar.gz</code></p>
<p>进入redis目录使用make命令安装redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd  redis-3.0.3</span><br><span class="line">make</span><br><span class="line">mkdir /home/redis</span><br><span class="line">cp redis-server  /home/redis</span><br><span class="line">cp redis-benchmark  /home/redis</span><br><span class="line">cp redis-cli  /home/redis</span><br><span class="line">cp redis.conf  /home/redis</span><br><span class="line">cd  /home/redis</span><br></pre></td></tr></table></figure>
<p>启动</p>
<p><code>./redis-server redis.conf</code></p>
<p>进入命令交互模式，两种：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1:   ./redis-cli</span><br><span class="line">2:   telnet 127.0.0.1 6379       (ip接端口)</span><br></pre></td></tr></table></figure>
<p>关闭redis服务</p>
<p><code>/opt/redis/bin/redis-cli shutdown</code></p>
<p>开启redis服务</p>
<p><code>/opt/redis/bin/redis-server /opt/redis/etc/redis.conf</code></p>
<p>注意把开启redis服务的命令放到/etc/rc.local中。</p>
</li>
<li><p>配置文件参数说明</p>
<p>Redis默认不是以守护进程的方式运行，可以通过该配置项修改，使用yes启用守护进程</p>
<p><code>daemonize no</code></p>
<p>当Redis以守护进程方式运行时，Redis默认会把pid写入/var/run/redis.pid文件，可以通过pidfile指定</p>
<p><code>pidfile /var/run/redis.pid</code></p>
<p>指定Redis监听端口，默认端口为6379，作者在自己的一篇博文中解释了为什么选用6379作为默认端口，因为6379在手机按键上MERZ对应的号码，而MERZ取自意大利歌女Alessia Merz的名字</p>
<p><code>port 6379</code></p>
<p>绑定的主机地址</p>
<p><code>bind 127.0.0.1</code></p>
<p>当客户端闲置多长时间后关闭连接，如果指定为0，表示关闭该功能</p>
<p><code>timeout 300</code></p>
<p>指定日志记录级别，Redis总共支持四个级别：debug、verbose、notice、warning，默认为verbose</p>
<p><code>loglevel verbose</code></p>
<p>日志记录方式，默认为标准输出，如果配置Redis为守护进程方式运行，而这里又配置为日志记录方式为标准输出，则日志将会发送给/dev/null</p>
<p><code>logfile stdout</code></p>
<p>设置数据库的数量，默认数据库为0，可以使用SELECT 命令在连接上指定数据库id</p>
<p><code>databases 16</code></p>
<p>指定在多长时间内，有多少次更新操作，就将数据同步到数据文件，可以多个条件配合save ,Redis默认配置文件中提供了三个条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>
<p>分别表示900秒（15分钟）内有1个更改，300秒（5分钟）内有10个更改以及60秒内有10000个更改。</p>
<p>指定存储至本地数据库时是否压缩数据，默认为yes，Redis采用LZF压缩，如果为了节省CPU时间，可以关闭该选项，但会导致数据库文件变的巨大</p>
<p><code>rdbcompression yes</code></p>
<p>指定本地数据库文件名，默认值为dump.rdb</p>
<p><code>dbfilename dump.rdb</code></p>
<p>指定本地数据库存放目录</p>
<p><code>dir ./</code></p>
<p>设置当本机为slav服务时，设置master服务的IP地址及端口，在Redis启动时，它会自动从master进行数据同步</p>
<p><code>slaveof</code></p>
<p>当master服务设置了密码保护时，slav服务连接master的密码</p>
<p><code>masterauth</code></p>
<p>设置Redis连接密码，如果配置了连接密码，客户端在连接Redis时需要通过AUTH 命令提供密码，默认关闭</p>
<p><code>requirepass foobared</code></p>
<p>设置同一时间最大客户端连接数，默认无限制，Redis可以同时打开的客户端连接数为Redis进程可以打开的最大文件描述符数，如果设置 maxclients 0，表示不作限制。当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients reached错误信息</p>
<p><code>maxclients 128</code></p>
<p>指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key，当此方法处理 后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis新的vm机制，会把Key存放内存，Value会存放在swap区</p>
<p><code>maxmemory</code></p>
<p>指定是否在每次更新操作后进行日志记录，Redis在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为 redis本身同步数据文件是按上面save条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为no</p>
<p><code>appendonly no</code></p>
<p>指定更新日志文件名，默认为appendonly.aof</p>
<p><code>appendfilename appendonly.aof</code></p>
<p>指定更新日志条件，共有3个可选值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">no：表示等操作系统进行数据缓存同步到磁盘（快）</span><br><span class="line">always：表示每次更新操作后手动调用fsync()将数据写到磁盘（慢，安全）</span><br><span class="line">everysec：表示每秒同步一次（折衷，默认值）</span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>
<p>指定是否启用虚拟内存机制，默认值为no，简单的介绍一下，VM机制将数据分页存放，由Redis将访问量较少的页即冷数据swap到磁盘上，访问多的页面由磁盘自动换出到内存中（在后面的文章我会仔细分析Redis的VM机制）</p>
<p><code>vm-enabled no</code></p>
<p>虚拟内存文件路径，默认值为/tmp/redis.swap，不可多个Redis实例共享</p>
<p><code>vm-swap-file /tmp/redis.swap</code></p>
<p>将所有大于vm-max-memory的数据存入虚拟内存,无论vm-max-memory设置多小,所有索引数据都是内存存储的(Redis的索引数据 就是keys),也就是说,当vm-max-memory设置为0的时候,其实是所有value都存在于磁盘。默认值为0</p>
<p><code>vm-max-memory 0</code></p>
<p>Redis swap文件分成了很多的page，一个对象可以保存在多个page上面，但一个page上不能被多个对象共享，vm-page-size是要根据存储的 数据大小来设定的，作者建议如果存储很多小对象，page大小最好设置为32或者64bytes；如果存储很大大对象，则可以使用更大的page，如果不 确定，就使用默认值</p>
<p><code>vm-page-size 32</code></p>
<p>设置swap文件中的page数量，由于页表（一种表示页面空闲或使用的bitmap）是在放在内存中的，，在磁盘上每8个pages将消耗1byte的内存。</p>
<p><code>vm-pages 134217728</code></p>
<p>设置访问swap文件的线程数,最好不要超过机器的核数,如果设置为0,那么所有对swap文件的操作都是串行的，可能会造成比较长时间的延迟。默认值为4</p>
<p><code>vm-max-threads 4</code></p>
<p>设置在向客户端应答时，是否把较小的包合并为一个包发送，默认为开启</p>
<p><code>glueoutputbuf yes</code></p>
<p>指定在超过一定的数量或者最大的元素超过某一临界值时，采用一种特殊的哈希算法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hash-max-zipmap-entries 64</span><br><span class="line">hash-max-zipmap-value 512</span><br></pre></td></tr></table></figure>
<p>指定是否激活重置哈希，默认为开启（后面在介绍Redis的哈希算法时具体介绍）</p>
<p><code>activerehashing yes</code></p>
<p>指定包含其它的配置文件，可以在同一主机上多个Redis实例之间使用同一份配置文件，而同时各个实例又拥有自己的特定配置文件</p>
<p><code>include /path/to/local.conf</code></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Riky Lee" />
          <p class="site-author-name" itemprop="name">Riky Lee</p>
           
              <p class="site-description motion-element" itemprop="description">享受生活，享受自己</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Riky Lee</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("sKghf9TSl0YblmUyfqxDkvMI-gzGzoHsz", "1KnuVkG5OU880DbIaJg2X0TI");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
